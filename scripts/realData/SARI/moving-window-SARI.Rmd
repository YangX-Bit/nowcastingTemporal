---
title: "MovingWindowSims"
author: "Yang Xiao"
date: "2024-11-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)

library(splines)
library(ggplot2)
library(reshape2)
library(aweek)
library(lubridate)
library(latex2exp)

#remotes::install_github("stan-dev/cmdstanr")
library(cmdstanr)
# cmdstanr::check_cmdstan_toolchain(fix = TRUE)
# install_cmdstan(cores = 4, overwrite = TRUE)
# set_cmdstan_path(path = "C:/Users/Administrator/.cmdstan/cmdstan-2.35.0")
# cmdstan_version()
```

```{r}
path_proj = here::here()
path_source = file.path(path_proj, "source")

source(file.path(path_source, "functions", "dengue_tracker_functions.R"))
source(file.path(path_source, "functions", "tidy_dengueBR.R"))
source(file.path(path_source, "functions", "fit_function.R"))
source(file.path(path_source, "functions", "metrics.R"))
aweek::set_week_start("Sunday")

path_source_nowcasting <- file.path(dirname(path_proj), "nowcasting", "source")
source(file.path(path_source_nowcasting, "simulation", "simulations_functions_final.R"))
source(file.path(path_source_nowcasting, "functions", "prior_function.R"))
source(file.path(path_source_nowcasting, "functions", "fit_function.R"))
source(file.path(path_source_nowcasting, "functions", "plot_function.R"))
source(file.path(path_source_nowcasting, "funcs_german_paper", "plotReportingTriangle.R"))

source(file.path(path_source_nowcasting, "functions", "table_function.R"))

# data import
SARI <- as.data.frame(read.csv(file.path(dirname(path_source_nowcasting), "data", "raw", "clean_data_srag_epiweek_delay_table_PR.csv"),))

# set week
set_week_start("Sunday")
SARI$date <- get_date(week = SARI$epiweek, year = SARI$epiyear)


# mac
# posterior_draws_path = file.path(Sys.getenv("HOME"), "Desktop", "draws", "SARI")
path_to_draws_BR <- file.path(file.path(dirname(dirname(path_proj)),"projects","draws","SARI"))


#Windows
#posterior_draws_path = file.path(Sys.getenv("USERPROFILE"), "Desktop", "draws", "realData", "SARI")

```

```{r}
#models
baseline <-  file.path(path_source_nowcasting,  "models", "b-ou.stan")
proposed <- file.path(path_source,  "models", "nowcast_hist_triangle_no_cov.stan")


compiled_models <- list(
  baseline = cmdstan_model(baseline),
  baseline2 = cmdstan_model(baseline),
  proposed = cmdstan_model(proposed)
)

models_to_use <- c("baseline", "proposed")
```

```{r}
# long table
data_long <- SARI %>%
  select(regionalsaude, date, Notifications) %>%
  #filter(date > as.Date("2014-01-01")) %>%
  pivot_longer(cols = Notifications, names_to = "delay", values_to = "value")

# case ts plots
ts <- ggplot(data_long, aes(x = date, y = value)) +
  geom_line(color = "steelblue") +
  
  facet_wrap(~ regionalsaude, scales = "free_y") +
  labs(title = "SARI cases by region",
       x = "Date", y = "cases notifications") +
  theme_minimal()+
  theme(    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1))

print(ts)
```

```{r}

data_long2 <- SARI %>%
  select(date, Notifications, regionalsaude) %>%
  filter(date > as.Date("2011-01-01"),
         regionalsaude != 0) %>%
  pivot_longer(
    cols = Notifications, names_to = "delay", values_to = "value"
  ) %>%
  group_by(date, delay) %>%
  summarise(value = sum(value, na.rm = TRUE), .groups = "drop")

ts2 <- ggplot(data_long2, aes(x = date, y = value)) +
  geom_line(color = "steelblue") +
  labs(title = "SARI cases by region",
       x = "Date", y = "cases notifications") +
  theme_minimal()+
  theme(    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1))

print(ts2)
```


```{r, warning=FALSE}
# setting: delay,  number of days
seed <- 123

set.seed(seed)
#D <- 10
D <- 15
N_obs <- 200

# try-on in region 41002
# data_41002 <- SARI %>% filter(regionalsaude == 41002) %>%
#   select(-c("epiweek","epiyear","regionalsaude")) %>%
#   relocate(Notifications, .after = last_col())
# rownames(data_41002) <- data_41002$date
# 
# plot(x = data_41002$date,y = data_41002$Notifications, type = "l")
unique(SARI$regionalsaude)

SARI_collapsed_all <- SARI %>%
  filter(regionalsaude != 0) %>%
  group_by(date, epiyear, epiweek ) %>%
  summarise(across(-regionalsaude, ~ sum(.x, na.rm = TRUE)), .groups = "drop") 

SARI_collapsed <- SARI_collapsed_all %>% # combine
  select(-c("epiweek","epiyear")) %>%
  relocate(Notifications, .after = last_col())

date_serie <- SARI_collapsed$date
rownames(SARI_collapsed) <- date_serie
SARI_collapsed <- SARI_collapsed %>% select(-date)

#transfer to cumu matrix
# data_41002[,c(1:(D+1))] <- cumulative_matrix(as.matrix(data_41002[,c(1:(D+1))]))
# data_41002_input <- as.matrix(data_41002[,c(1:(D+1))])

SARI_collapsed[,c(1:(D+1))] <- cumulative_matrix(as.matrix(SARI_collapsed[,c(1:(D+1))]))
SARI_collapsed_input <- as.matrix(SARI_collapsed[,c(1:(D+1))])
rownames(SARI_collapsed_input) <- as.character(date_serie)

# now <- as.Date("2024-02-01")
scoreRange <- seq(as.Date("2009-07-05"),as.Date("2010-07-05"),by="56 day")

# input the true case vector
# case_true <- as.matrix(data_41002[, c("Notifications")])
# rownames(case_true) <- as.character(data_41002$date)

case_true <- as.matrix(SARI_collapsed[, c("Notifications")])
rownames(case_true) <- as.character(date_serie)

```

```{r}
generate_fourier_basis <- function(weeks, H_max = 3, period = 52) {
  if (inherits(weeks, "Date")) {
    weeks <- seq_along(weeks)
  }
  
  angle <- 2 * pi * (weeks - 1) / period
  
  fourier_list <- lapply(1:H_max, function(h) {
    cbind(
      cos = cos(h * angle),
      sin = sin(h * angle)
    )
  })
  
  basis <- do.call(cbind, fourier_list)
  
  # colnames
  colnames(basis) <- unlist(lapply(1:H_max, function(h) {
    c(paste0("cos_h", h), paste0("sin_h", h))
  }))
  
  return(basis)
}

weeks_per_yr <- 52
t <- 1:(weeks_per_yr * 3)
fourier_basis <- generate_fourier_basis(t, H_max = 10, period = weeks_per_yr)
H_used <- 3

```

# Expected
```{r}

total_cases <- SARI_collapsed_all %>%
  filter(date >= as.Date("2015-03-22") & date <= as.Date("2015-09-28")) %>%
  select(Notifications)

total_cases <- sum(total_cases$Notifications)

# 144 muni in state Parana
pop <- 8165436



```


```{r}
# scoreRange_SARI <- seq(as.Date("2009-08-02"),as.Date("2009-11-22"), by = "4 week")
# scoreRange_SARI
# first_date <- as.Date("2009-06-14")
set.seed(seed)

scoreRange_SARI <- seq(as.Date("2015-03-22"),as.Date("2015-09-28"), by = "4 week")

first_date <- as.Date("2014-01-01")
start_date_tri <- as.Date("2015-01-04 ")

hypers <- hypers_q(phi_ref = 0.2, D_ref = 26, type = "exponential", alpha_phi = 1.4, sd_log_b = 0.5, delay_seq = 0:26)

out_SARI <- nowcasting_moving_window_with_temporal(SARI_collapsed_input,  scoreRange = scoreRange_SARI,
                                case_true = case_true,
                                start_date = first_date,
                                start_date_triangular = start_date_tri,
                                D = D,
                                methods = models_to_use,
                                compiled_models = compiled_models,
                                S = H_used * 2, bases_s = fourier_basis[, 1:(H_used * 2)],
                                E = 50,
                                iter_sampling = 2500, iter_warmup = 1000, refresh = 0,
                                num_chains = 4, suppress_output = T,
                                posterior_draws_path = path_to_draws_BR, hypers = hypers)
save(out_SARI, file = file.path(path_proj, "data", "results", "SARI","SARI_D=15.RData"))
# load( file.path(path_proj, "data", "results", "SARI","SARI_D=15.RData"))
#case_true - as.numeric(data_41002_input[,26])

# mat_y <- normalize_matrix_columns(data41002_exp_plot)

# last_reported <- as.matrix(data_41002[, c("Notifications_within_26w")])
# rownames(last_reported) <- as.character(data_41002$date)
```

```{r, warning=F}
L <- 4

tmp_crps <- tmp_hist_crps <- numeric(length(out_SARI$dates))
tmp_mcr50 <- tmp_hist_mcr50 <- numeric(length(out_SARI$dates))
tmp_mcr95 <- tmp_hist_mcr95 <- numeric(length(out_SARI$dates))

for (i in 1:length(out_SARI$dates)) {
  num_N <- ncol(out_SARI$baseline[[i]]$draws(variables = "N", format = "draws_matrix"))
  num_N_hist <- ncol(out_SARI$proposed[[i]]$draws(variables = "N", format = "draws_matrix"))
  
  pred <- get_N_lastL_draws(out_SARI$baseline[[i]]$output_files(), num_N, min(num_N, L), if_impute = T)
  pred_hist <- get_N_lastL_draws(out_SARI$proposed[[i]]$output_files(), num_N_hist, min(num_N_hist, L), if_impute = T)
  
  y_true <- as.numeric(tail(out_SARI$case_true[[i]], min(num_N, L)))
    # crps
  tmp_crps[i] <- mean(scoringRules::crps_sample(y = y_true, dat = pred))
  tmp_hist_crps[i]  <- mean(scoringRules::crps_sample(y = y_true, dat = pred_hist))
  
  # 50%
  tmp_mcr50[i] <- coverage_rate_sample(y_true, pred, level = 0.50)
  tmp_hist_mcr50[i]  <- coverage_rate_sample(y_true, pred_hist,  level = 0.50)
  # 95%
  tmp_mcr95[i] <- coverage_rate_sample(y_true, pred, level = 0.95)
  tmp_hist_mcr95[i]  <- coverage_rate_sample(y_true, pred_hist,  level = 0.95)
}

```

```{r}
results_list <- out_SARI 
nowcasts_table_sari<- function(results_list, 
                           D = NULL,
                           report_unit = "week",
                           methods = c("fixed_q", "fixed_b", "linear_b", "ou_b"),
                           N_num = NULL,
                           replicate_id = NA_integer_, alpha = 0.05) {
  # Basic checks
  if (is.null(D)) stop("Parameter 'D' must be provided.")
  if (!report_unit %in% c("week", "day")) {
    stop("report_unit must be 'week' or 'day'.")
  }
  
  library(lubridate)
  library(dplyr)
  
  # Decide factor for date shifting
  factor_loc <- if (report_unit == "week") 7 else 1
  nowcasts_out <- list()
  n_runs <- length(N_num)  # how many sets of data we have
  for (i in 1:n_runs) {
    # Extract data
    case_true     <- results_list[["case_true"]][[i]]
    case_reported <- results_list[["case_reported"]][[i]]
    dates         <- results_list[["dates"]][[i]]
    
    # Basic date references
    now      <- as.Date(dplyr::last(dates))
    earliest <- as.Date(dplyr::first(dates))
    last_date_for_delay <- now - days(D * factor_loc)
    
    # Initialize a data frame for storing nowcasts
    nowcasts_df <- data.frame(
      date          = dates,
      case_true     = case_true,
      case_reported = case_reported,
      row.names     = seq_along(dates)
    )
    
    # Store these references as columns (the same for all rows in this i)
    nowcasts_df$now                <- now
    nowcasts_df$earliest           <- earliest
    nowcasts_df$last_date_for_delay <- last_date_for_delay
    N_all <- nrow(nowcasts_df)
    # cut

    nowcasts_df <- tail(nowcasts_df, N_num[i])
    
    if (!is.na(replicate_id)) {
      nowcasts_df$replicate_id       <- replicate_id # for replicate
    }
    
    lower_p <- alpha / 2
    upper_p <- 1 - alpha / 2
    
    last_vars <- paste0("N[", (N_all - N_num[i] + 1):N_all, "]")

    # Dynamically add model results
    for (model_name in methods) {
      # model_name might be "fixed_q", "fixed_b", ...
      if(model_name != "baseline"){
        samples <- results_list[[model_name]][[i]]$draws(variables = "N", format = "draws_matrix")[, last_vars]
      }else {
        samples <- results_list[[model_name]][[i]]$draws(variables = "N", format = "draws_matrix")
      }
      nowcasts_df[[paste0("mean_", model_name)]]  <- apply(samples, 2, mean)
      nowcasts_df[[paste0("lower_", model_name)]] <- apply(samples, 2, quantile, probs = lower_p, na.rm = TRUE)
      nowcasts_df[[paste0("upper_", model_name)]] <- apply(samples, 2, quantile, probs = upper_p, na.rm = TRUE)
    }
    
    # EW
    nowcasts_df  <- nowcasts_df %>% mutate(eval_t = date_to_ew(now),
                                           pred_weeks = date_to_ew(date))
    
    # Save to output list
    nowcasts_out[[i]] <- nowcasts_df
  }
  
  return(nowcasts_out)
}

```



```{r}
library(dplyr)

# helper func
safe_rmspe <- function(pred, actual, eps = 1e-8) {
  sqrt(mean(((pred - actual) / pmax(actual, eps))^2, na.rm = TRUE)) * 100
}
safe_mape <- function(pred, actual, eps = 1e-8) {
  mean(abs((pred - actual) / pmax(actual, eps)), na.rm = TRUE) * 100
}
coverage_rate <- function(truth, lwr, upr) {
  mean(truth >= lwr & truth <= upr, na.rm = TRUE)
}

# calc metrics
calc_metrics <- function(df) {
  truth <- df$Notifications
  
  tibble(
    model = c("baseline", "proposed"),
    RMSE  = c(
      sqrt(mean((df$mean_baseline - truth)^2, na.rm = TRUE)),
      sqrt(mean((df$mean_proposed - truth)^2, na.rm = TRUE))
    ),
    RMSPE = c(
      safe_rmspe(df$mean_baseline, truth),
      safe_rmspe(df$mean_proposed, truth)
    ),
    MAE   = c(
      mean(abs(df$mean_baseline - truth), na.rm = TRUE),
      mean(abs(df$mean_proposed - truth), na.rm = TRUE)
    ),
    MAPE  = c(
      safe_mape(df$mean_baseline, truth),
      safe_mape(df$mean_proposed, truth)
    )
  )
}

N_num <- as.numeric((scoreRange_SARI - start_date_tri)/7)
results_SARI <- nowcasts_table_sari(out_SARI, D = D, report_unit = "week", 
                          methods = models_to_use, N_num = N_num)
# names(results_SARI) <- sapply(scoreRange_SARI, function(x) TeX(as.character(x), bold = TRUE))

#  list
final_metrics <- lapply(results_SARI, calc_metrics)

print(final_metrics)

for (i in 1:length(out_SARI$dates)) {
  crps_sari <- as.numeric(c(tmp_crps[[i]], tmp_hist_crps[[i]]))
  mcr95_sari <- as.numeric(c(tmp_mcr95[[i]], tmp_hist_mcr95[[i]]))
  mcr50_sari <- as.numeric(c(tmp_mcr50[[i]], tmp_hist_mcr50[[i]]))
  final_metrics[[i]]$crps <- crps_sari
  final_metrics[[i]]$mcr95 <- mcr95_sari
  final_metrics[[i]]$mcr50 <- mcr50_sari
}


final_avg <- bind_rows(final_metrics, .id = "id") %>% 
  group_by(model) %>%
  summarise(
    RMSE  = round(mean(RMSE,  na.rm = TRUE), 2),
    RMSPE = round(mean(RMSPE, na.rm = TRUE), 2),
    MAE   = round(mean(MAE,   na.rm = TRUE), 2),
    MAPE  = round(mean(MAPE,  na.rm = TRUE), 2),
    crps  = round(mean(crps,  na.rm = TRUE), 2),
    mcr95 = round(mean(mcr95, na.rm = TRUE), 2),
    mcr50 = round(mean(mcr50, na.rm = TRUE), 2),
    .groups = "drop"
  )    %>%   select(-c("MAE", "MAPE")) 


print(final_avg)

xtable(final_avg, digits = 2, 
         caption = "Model comparison of error metrics")
#
final_metrics_out <- bind_rows(final_metrics)

xtable(final_metrics_out, digits = 2, 
         caption = "Model comparison of error metrics")
```

```{r}
library(writexl)

# write
write_xlsx(final_metrics_out, file.path(path_proj, "plots_to_show","SARI","final_metrics_D15.xlsx"))

```



```{r}
final_wide <- final_metrics_out %>%
  mutate(time = rep(1:(n()/2), each = 2)) %>%  
  pivot_wider(
    id_cols = time,
    names_from = model,
    values_from = c(RMSE, RMSPE, crps, mcr95, mcr50)
  ) %>% mutate(time = as.character(scoreRange_SARI)) %>%
   mutate(across(where(is.numeric), ~ round(.x, 2)))

make_latex_table <- function(df) {
  out <- "\\begin{table}[!h]\\footnotesize
\\centering
\\begin{tabular}[t]{c *{10}{c}}
\\toprule
 & \\multicolumn{2}{c}{RMSE} & \\multicolumn{2}{c}{RMSPE} & \\multicolumn{2}{c}{CRPS} & \\multicolumn{2}{c}{MCR95} & \\multicolumn{2}{c}{MCR50} \\\\
\\cmidrule(l{3pt}r{3pt}){2-3} \\cmidrule(l{3pt}r{3pt}){4-5} \\cmidrule(l{3pt}r{3pt}){6-7} \\cmidrule(l{3pt}r{3pt}){8-9} \\cmidrule(l{3pt}r{3pt}){10-11}
 & Baseline & Proposed & Baseline & Proposed & Baseline & Proposed & Baseline & Proposed & Baseline & Proposed\\\\
\\midrule
"

  for (i in seq_len(nrow(df))) {
    row <- df[i, ]

    hl <- function(b, p, mode = "smaller", target = 1) {
      if (is.na(b) | is.na(p)) return(c(b, p))
      
      b <- as.numeric(b)
      p <- as.numeric(p)

      if (isTRUE(all.equal(b, p))) {
        return(c(b, p))
      }
      
      if (mode == "smaller") {
        if (p < b) c(b, paste0("\\textcolor{red}{\\textbf{", p, "}}"))
        else       c(paste0("\\textcolor{red}{\\textbf{", b, "}}"), p)
        
      } else if (mode == "larger") {
        if (p > b) c(b, paste0("\\textcolor{red}{\\textbf{", p, "}}"))
        else       c(paste0("\\textcolor{red}{\\textbf{", b, "}}"), p)
        
      } else if (mode == "closer") {
        dist_b <- abs(b - target)
        dist_p <- abs(p - target)
        if (dist_p < dist_b) c(b, paste0("\\textcolor{red}{\\textbf{", p, "}}"))
        else                 c(paste0("\\textcolor{red}{\\textbf{", b, "}}"), p)
      }
    }


    vals <- c(
      hl(row$RMSE_baseline,  row$RMSE_proposed,  mode = "smaller"),
      hl(row$RMSPE_baseline, row$RMSPE_proposed, mode = "smaller"),
      hl(row$crps_baseline,  row$crps_proposed,  mode = "smaller"),
      hl(row$mcr95_baseline, row$mcr95_proposed, mode = "closer", target = 0.95),
      hl(row$mcr50_baseline, row$mcr50_proposed, mode = "closer", target = 0.5)
    )


    out <- paste0(out, row$time, " & ", paste(vals, collapse = " & "), " \\\\\n")
  }

  out <- paste0(out, "\\bottomrule\n\\end{tabular}\n\\end{table}")
  return(out)
}

latex_code <- make_latex_table(final_wide)
cat(latex_code)

```



```{r}
out_SARI_D26 <- nowcasting_moving_window_with_temporal(SARI_collapsed_input,  scoreRange = scoreRange_SARI,
                                case_true = case_true,
                                start_date = first_date,
                                start_date_triangular = start_date_tri,
                                D = 26,
                                methods = models_to_use,
                                compiled_models = compiled_models,
                                S = H_used * 2, bases_s = fourier_basis[, 1:(H_used * 2)],
                                E = 40,
                                iter_sampling = 2500, iter_warmup = 1000, refresh = 0,
                                num_chains = 4, suppress_output = T,
                                posterior_draws_path = path_to_draws_BR, hypers = hypers)
save(out_SARI_D26, file = file.path(path_proj, "data", "results", "SARI","SARI_090802_to_901122_D=26.RData"))

```



# plot 
## data process
```{r}
results_SARI_plot <- bind_rows(results_SARI)


df_long <- results_SARI_plot %>%
  select(date, Notifications, case_reported, actual = Notifications,
         starts_with("mean_"), starts_with("lower_"), starts_with("upper_"),
         eval_t, pred_weeks) %>%
  pivot_longer(
    cols = matches("^(mean|lower|upper)_(baseline|proposed)$"),
    names_to = c("stat", "model"),
    names_pattern = "(mean|lower|upper)_(baseline|proposed)",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = stat,
    values_from = value
  ) %>%
  rename(
    mean  = mean,
    l95   = lower,
    u95   = upper
  ) %>%
  mutate(
    model = recode(model,
                   baseline = "Baseline",
                   proposed = "Proposed")
  )

```

```{r}
library(ggplot2)
library(dplyr)

# color
method_colors <- c(
  "Baseline"       = "#96C37D",
  "Proposed"       = "#2F7FC1",
  "Actual cases"   = "#C82423",
  "Reported cases" = "black"
)

plot_out_sari <- ggplot(df_plot, aes(x = date)) +
  # ribbons (interval)
  geom_ribbon(
    aes(ymin = l95, ymax = u95, fill = model,
        group = interaction(model, eval_t)),
    alpha = 0.25, show.legend = FALSE, na.rm = TRUE
  ) +
  # posterior mean
  geom_line(
    aes(y = mean, color = model,
        group = interaction(model, eval_t)),
    linewidth = 0.4, show.legend = FALSE, na.rm = TRUE
  ) +
  # reported overlay 
  geom_line(
    aes(y = case_reported, color = "Reported cases",
        group = interaction(model, eval_t)),
    linewidth = 0.4, show.legend = TRUE, na.rm = TRUE
  ) +
  geom_point(
    aes(y = case_reported, color = "Reported cases",
        group = interaction(model, eval_t)),
    size = 0.5, show.legend = TRUE, na.rm = TRUE
  ) +
  # truth overlay 
  geom_line(
    aes(y = actual, color = "Actual cases",
        group = interaction(model, eval_t)),
    linewidth = 0.5, linetype = 6, show.legend = TRUE, na.rm = TRUE
  ) +
  # facet: row=model, col=eval_t
  facet_grid(
    rows = vars(model), 
    cols = vars(eval_t),         
    scales = "free_x",
    switch = "y"
  ) +
  # color and fill
  scale_color_manual(
    values = method_colors,
    breaks = c("Actual cases", "Reported cases"),
    name = NULL
  ) +
  scale_fill_manual(
    values = method_colors[c("Baseline","Proposed")],
    guide = "none"
  ) +
  labs(x = NULL, y = "Number of cases") +
  theme_bw(base_size = 10) +
  theme(
    legend.position      = c(0.15, 0.995),
    legend.justification = c(1, 1),
    legend.background    = element_rect(fill = scales::alpha("white", 0.75), color = NA),
    legend.key.height    = unit(0.25, "cm"),
    legend.key.width     = unit(0.5, "cm"),
    legend.text          = element_text(size = 7),
    strip.background     = element_blank(),
    strip.text           = element_text(face = "bold"),
    panel.grid.minor     = element_blank(),
    panel.grid.major.x   = element_blank(),
    axis.title.y         = element_text(margin = margin(r = 6))
  ) +
  guides(color = guide_legend(
    override.aes = list(
      linetype  = c(6, 1),   # Actual cases = dashed, Reported = solid
      shape     = c(NA, 16), # Actual cases = line only, Reported = point
      linewidth = c(0.5, 0.5),
      size      = c(NA, 1)
    )
  ))

plot_out_sari

ggsave(filename = file.path(path_proj, "plots_to_show", "SARI", "results_sari.png"),
       plot = plot_out_sari,
       width = 12, height = 8, dpi = 300)

```


---
title: "Multi_states_BR"
author: "Yang Xiao"
date: "2025-09-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(cmdstanr)
library(bayesplot)
```

```{r}
path_proj = here::here()
path_source = file.path(path_proj, "source")

source(file.path(path_source, "functions", "dengue_tracker_functions.R"))
source(file.path(path_source, "functions", "tidy_dengueBR.R"))
source(file.path(path_source, "functions", "fit_function.R"))
source(file.path(path_source, "functions", "metrics.R"))
aweek::set_week_start("Sunday")

path_source_nowcasting <- file.path(dirname(path_proj), "nowcasting", "source")
source(file.path(path_source_nowcasting, "simulation", "simulations_functions_final.R"))
source(file.path(path_source_nowcasting, "functions", "prior_function.R"))
source(file.path(path_source_nowcasting, "functions", "fit_function.R"))
source(file.path(path_source_nowcasting, "functions", "plot_function.R"))

path_source_denguetracker_data <- file.path(dirname(path_proj), "dengue-tracker/data/weekly_data/")
path_source_denguetracker_infodengue <- file.path(path_source_denguetracker_data, "infodengue")
path_source_denguetracker_GT <- file.path(path_source_denguetracker_data, "gtrends")

path_to_draws_BR <- file.path(file.path(dirname(dirname(path_proj)),"projects","draws","BR"))

```


```{r}
brazil_ufs <- c(
  "AC", "AL", "AP", "AM",
  "BA", "CE", "DF", "ES",
  "GO", "MA", "MT", "MS",
  "MG", "PA", "PB", "PR",
  "PE", "PI", "RJ", "RN",
  "RS", "RO", "RR", "SC",
  "SP", "SE", "TO"
)

case_data <- list()
case_date <- tail(readr::read_csv(file.path(path_source_denguetracker_infodengue,
                                             202519,paste0("AC","_","2025-05-11","_infodengue.csv"))),62)$ew_start
for (i in 1:length(brazil_ufs)) {
  case_data[[brazil_ufs[i]]] <- tail(readr::read_csv(file.path(path_source_denguetracker_infodengue,
                                             202519,paste0(brazil_ufs[i],"_","2025-05-11","_infodengue.csv"))),62)$sum_of_cases  
}
```

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
library(readr)
# transfer the data
case_df <- map_dfr(names(case_data), function(uf) {
  tibble(
    date = case_date,
    cases = case_data[[uf]],
    uf = uf
  )
})


ggplot(case_df, aes(x = date, y = cases, color = uf)) +
  geom_line(size = 1) +
  geom_vline(xintercept = as.Date("2024-07-01"), 
             linetype = "dashed", color = "black", size = 0.8) +
  labs(title = NULL,
       x = "Date", y = "Number of Cases") +
  theme_minimal() +
  theme(legend.position = "right")

```

```{r}
ggplot(case_df, aes(x = date, y = cases)) +
  geom_line(color = "steelblue", size = 0.8) +
  geom_vline(xintercept = as.Date("2024-07-28"), 
             linetype = "dashed", color = "black", size = 0.8) +
  facet_wrap(~ uf, scales = "free_y", ncol = 6) +
  labs(title = "Dengue Case Trends per State",
       x = "Date", y = "Number of Cases") +
  theme_minimal(base_size = 12) +
  theme(strip.text = element_text(face = "bold"))

exposure <- case_df %>% group_by(uf) %>% mutate(exposure = max(cases)/3)%>%
  select(uf,exposure) %>% unique()
exposure <- exposure[-8,]

```

## the test
### function
```{r}
# 更稳健的误差函数（避免 actual = 0 时除零）
safe_rmspe <- function(pred, actual, eps = 1e-8) {
  sqrt(mean(((pred - actual) / pmax(actual, eps))^2, na.rm = TRUE)) * 100
}
safe_mape <- function(pred, actual, eps = 1e-8) {
  mean(abs((pred - actual) / pmax(actual, eps)), na.rm = TRUE) * 100
}
rmse_fun <- function(pred, actual) sqrt(mean((pred - actual)^2, na.rm = TRUE))
mae_fun  <- function(pred, actual) mean(abs(pred - actual), na.rm = TRUE)

# 覆盖率
coverage_rate <- function(truth, lwr, upr) {
  mean(truth >= lwr & truth <= upr, na.rm = TRUE)
}

# 基于正态近似的 CRPS（用 95% 区间反推 σ，再计算 CRPS(N(μ,σ), y)）
crps_normal_vec <- function(y, mu, lwr95, upr95) {
  z975 <- qnorm(0.975)
  sigma <- (upr95 - lwr95) / (2 * z975)
  # 避免 sigma = 0
  sigma <- pmax(sigma, 1e-8)
  z <- (y - mu) / sigma
  # φ 和 Φ
  phi <- dnorm(z)
  Phi <- pnorm(z)
  # CRPS 公式：σ [ 1/√π - 2 φ(z) - z(2Φ(z)-1) ]
  crps <- sigma * (1 / sqrt(pi) - 2 * phi - z * (2 * Phi - 1))
  mean(crps, na.rm = TRUE)
}

# 由 95% 区间近似出 50% 区间（正态：μ ± z0.75 * σ）
make_50_ci_from_95 <- function(mu, lwr95, upr95) {
  z975 <- qnorm(0.975)
  z075 <- qnorm(0.75)  # 0.6744898
  sigma <- (upr95 - lwr95) / (2 * z975)
  sigma <- pmax(sigma, 1e-8)
  lwr50 <- mu - z075 * sigma
  upr50 <- mu + z075 * sigma
  list(lwr50 = lwr50, upr50 = upr50)
}

generate_fourier_basis <- function(weeks, H_max = 3, period = 52) {
  if (inherits(weeks, "Date")) {
    weeks <- seq_along(weeks)
  }
  
  angle <- 2 * pi * (weeks - 1) / period
  
  fourier_list <- lapply(1:H_max, function(h) {
    cbind(
      cos = cos(h * angle),
      sin = sin(h * angle)
    )
  })
  
  basis <- do.call(cbind, fourier_list)
  
  # colnames
  colnames(basis) <- unlist(lapply(1:H_max, function(h) {
    c(paste0("cos_h", h), paste0("sin_h", h))
  }))
  
  return(basis)
}

error_metrics <- function(predicted, actual) {
  # same length
  stopifnot(length(predicted) == length(actual))
  
  # RMSE (Root Mean Squared Error)
  rmse <- sqrt(mean((predicted - actual)^2))
  
  # RMSPE (Root Mean Squared Percentage Error)
  rmspe <- sqrt(mean(((predicted - actual)/actual)^2)) * 100
  
  # MAE (Mean Absolute Error)
  mae <- mean(abs(predicted - actual))
  
  # MAPE (Mean Absolute Percentage Error)
  mape <- mean(abs((predicted - actual)/actual)) * 100

  list(RMSE = rmse,
       RMSPE = rmspe,
       MAE = mae,
       MAPE = mape)
}

```

```{r}
# 拆分保存目录
fit_dir <- file.path(path_proj, "outputs", "fits")
dir.create(fit_dir, recursive = TRUE, showWarnings = FALSE)

weeks_per_yr <- 52
t <- 1:(weeks_per_yr * 3)
fourier_basis <- generate_fourier_basis(t, H_max = 10, period = weeks_per_yr)
H_used <- 3

all_states <- c(
  "AC", "AL", "AP", "AM",
  "BA", "CE", "DF", #"ES",
  "GO", "MA", "MT", "MS",
  "MG", "PA", "PB", "PR",
  "PE", "PI", "RJ", "RN",
  "RS", "RO", "RR", "SC",
  "SP", "SE", "TO"
)       
E_vec <- exposure$exposure   
include_GT <- T                      # if include GT

delay_D <- 15
iter_sampling <- 2500
iter_warmup <- 1000
window_length <- 10
thin <- 1
step_size <- 5
chain_num <- 4
refresh <- 3000

ew_start <- "202410"
ew_end <- "202430"
```


# MCMC

```{r, message=FALSE}
suppressMessages(
  suppressWarnings(
      for (i in seq_along(all_states)) {
        state_i <- all_states[i]
        E_val   <- E_vec[i]
        cat(sprintf(">>> [MCMC %d/%d] State = %s ...\n", i, length(all_states), state_i))
        
        # baseline (with actual value)
        baseline_i <- get_baseline_data(
          root_dir = path_source_denguetracker_data,
          states   = state_i,
          start    = ew_start,
          end      = ew_end,
          time_unit = "week",
          last_n   = 10
        ) %>%
          add_actual_cases(root_dir_infodengue = path_source_denguetracker_infodengue,
                           state = state_i,
                           202511)
        saveRDS(baseline_i, file.path(fit_dir, sprintf("%s_baseline.rds", state_i)))
        
        # M 1：ARABM
        results_i <- run_moving_window(
          root_dir_infodengue = path_source_denguetracker_infodengue,
          root_dir_GT         = path_source_denguetracker_GT,
          state               = state_i,
          full_start          = ew_start,
          full_end            = ew_end,
          step_size           = step_size,
          D                   = delay_D,
          hypers              = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential",
                                         alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15),
          model_file          = file.path(path_source_nowcasting, "models", "b-ou.stan"),
          model_name          = "ARABM",
          mode                = "expanding",
          iter_sampling       = iter_sampling,
          iter_warmup         = iter_warmup,
          chains              = chain_num,
          refresh             = refresh,
          posterior_draws_path = path_to_draws_BR
        )
        saveRDS(results_i, file.path(fit_dir, sprintf("%s_ARABM_fit.rds", state_i)))
        
        # M 2：ARABMwGT (GT + seasonality + E)
        results_wGT_i <- run_moving_window(
          root_dir_infodengue = path_source_denguetracker_infodengue,
          root_dir_GT         = path_source_denguetracker_GT,
          state               = state_i,
          full_start          = ew_start,
          full_end            = ew_end,
          step_size           = step_size,
          D                   = delay_D,
          hypers              = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential",
                                         alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15),
          E                   = E_val,
          S                   = H_used * 2,
          bases_s             = fourier_basis[, 1:(H_used * 2)],
          model_file          = file.path(path_source, "models", "nowcast_hist_triangle.stan"),
          model_name          = "ARABMwGT",
          mode                = "expanding",
          iter_sampling       = iter_sampling,
          iter_warmup         = iter_warmup,
          chains              = chain_num,
          refresh             = refresh,
          posterior_draws_path = path_to_draws_BR
        )
        saveRDS(results_wGT_i, file.path(fit_dir, sprintf("%s_ARABMwGT_fit.rds", state_i)))
      }
      
    )
  )


```


```{r, warning=F}
interval_metrics_list <- list()
L <- 4

suppressMessages(
  suppressWarnings(
    # get the metrics
    for (i in seq_along(all_states)){
      state_i <- all_states[i]
      cat(sprintf(">>> [MCMC %d/%d] State = %s ...\n", i, length(all_states), state_i))
      baseline_i   <- readRDS(file.path(fit_dir, sprintf("%s_baseline.rds", state_i)))
      results_i <- readRDS(file.path(fit_dir, sprintf("%s_ARABM_fit.rds", state_i)))
      results_wGT_i <- readRDS(file.path(fit_dir, sprintf("%s_ARABMwGT_fit.rds", state_i)))
      
      true_data <- baseline_i %>% select(ew_start, sum_of_cases_final) %>% unique()
      
      tmp_crps <- tmp_wGT_crps <- numeric(length(results_i))
      tmp_mcr50 <- tmp_wGT_mcr50 <- numeric(length(results_i))
      tmp_mcr95 <- tmp_wGT_mcr95 <- numeric(length(results_i))
      # For each different time T
      for (j in 1:length(results_i)) {
        
          fit <- as_cmdstan_fit(results_i[[j]]$fit_object$output_files())
          fit_wGT <- as_cmdstan_fit(results_wGT_i[[j]]$fit_object$output_files())
          
          # since the number of N is less in the baseline method
          num_N <- ncol(fit$draws(variables = "N", format = "draws_matrix"))
          num_N_wGT <- ncol(fit_wGT$draws(variables = "N", format = "draws_matrix"))
          
          # draws
          pred <- get_N_lastL_draws(results_i[[j]]$fit_object$output_files(), num_N, min(num_N, L))
          pred_wGT <- get_N_lastL_draws(results_wGT_i[[j]]$fit_object$output_files(), num_N_wGT, min(num_N, L)) # num_N is always smaller
          
          # get the case of actual sequence
          y_true <- true_data %>% filter(ew_start <= results_i[[j]]$window_end &
                                         ew_start >= results_i[[j]]$window_start) %>%
            select(sum_of_cases_final)
          y_true <- tail(y_true, min(num_N, L))
          
          # crps
          tmp_crps[j] <- mean(crps_sample(y = y_true$sum_of_cases_final, dat = pred))
          tmp_wGT_crps[j]  <- mean(crps_sample(y = y_true$sum_of_cases_final, dat = pred_wGT))
          
          # 50%
          tmp_mcr50[j] <- coverage_rate_sample(y_true$sum_of_cases_final, pred, level = 0.50)
          tmp_wGT_mcr50[j]  <- coverage_rate_sample(y_true$sum_of_cases_final, pred_wGT,  level = 0.50)
          # 95%
          tmp_mcr95[j] <- coverage_rate_sample(y_true$sum_of_cases_final, pred, level = 0.95)
          tmp_wGT_mcr95[j]  <- coverage_rate_sample(y_true$sum_of_cases_final, pred_wGT,  level = 0.95)
      }
        interval_metrics_list[[i]] <- list(
          crps_out = mean(tmp_crps),
          crps_wGT_out = mean(tmp_wGT_crps),
        
          mcr50_out = mean(tmp_mcr50),
          mcr50_wGT_out = mean(tmp_wGT_mcr50),
        
          mcr95_out = mean(tmp_mcr95),
          mcr95_wGT_out = mean(tmp_wGT_mcr95)
        )
}
  )
)


```

```{r}
all_metrics <- list()
include_GT <- T

for (i in seq_along(all_states)) {
  state_i <- all_states[i]
  cat(sprintf(">>> [EVAL %d/%d] State = %s ...\n", i, length(all_states), state_i))
  # read data
  baseline_i   <- readRDS(file.path(fit_dir, sprintf("%s_baseline.rds", state_i)))
  results_i    <- readRDS(file.path(fit_dir, sprintf("%s_ARABM_fit.rds", state_i)))
  results_wGT_i<- readRDS(file.path(fit_dir, sprintf("%s_ARABMwGT_fit.rds", state_i)))
  # results
  arabm_i     <- extract_N_summary(results_i,    num_N = 6) # 默认名：ARABM, ARABM_lwr, ARABM_upr
  arabm_wGT_i <- extract_N_summary(results_wGT_i,num_N = 6, model_name = "ARABMwGT")
  
  result_out_i <- baseline_i %>%
    left_join(arabm_i %>% select(ew_now, ew, ARABM, ARABM_lwr, ARABM_upr),
              by = c("ew_now", "ew")) %>%
    left_join(arabm_wGT_i %>% select(ew_now, ew, ARABMwGT, ARABMwGT_lwr, ARABMwGT_upr),
              by = c("ew_now", "ew"))
  # get the latest week
  n_last <- 1
  result_out_cut <- result_out_i %>%
    filter(!is.na(ARABM)) %>%
    group_by(ew_now) %>%
    slice_max(order_by = ew, n = n_last) %>%
    ungroup()
  # true number of cases
  truth <- result_out_cut$sum_of_cases_final
  
   #— calc metrics
  metric_tbl <- tibble(
    state  = state_i,
    model  = c("Bastos", "ARABM", "ARABMwGT"),
    RMSE   = c(
      rmse_fun(result_out_cut$cases_est_id, truth),
      rmse_fun(result_out_cut$ARABM,        truth),
      rmse_fun(result_out_cut$ARABMwGT,     truth)
    ),
    RMSPE  = c(
      safe_rmspe(result_out_cut$cases_est_id, truth),
      safe_rmspe(result_out_cut$ARABM,        truth),
      safe_rmspe(result_out_cut$ARABMwGT,     truth)
    ),
    MAE    = c(
      mae_fun(result_out_cut$cases_est_id, truth),
      mae_fun(result_out_cut$ARABM,        truth),
      mae_fun(result_out_cut$ARABMwGT,     truth)
    ),
    MAPE   = c(
      safe_mape(result_out_cut$cases_est_id, truth),
      safe_mape(result_out_cut$ARABM,        truth),
      safe_mape(result_out_cut$ARABMwGT,     truth)
    ),
    crps   = c(NA_real_, interval_metrics_list[[i]]$crps_out, interval_metrics_list[[i]]$crps_wGT_out), 
    mcr95   = c(NA_real_, interval_metrics_list[[i]]$mcr95_out, interval_metrics_list[[i]]$mcr95_wGT_out),
    mcr50   = c(NA_real_, interval_metrics_list[[i]]$mcr50_out, interval_metrics_list[[i]]$mcr50_wGT_out)
  )
  
  # optional for GT
  if (include_GT && "GT" %in% names(result_out_cut)) {
    metric_tbl <- bind_rows(
      tibble(
        state = state_i,
        model = "GT",
        RMSE  = rmse_fun(result_out_cut$GT, truth),
        RMSPE = safe_rmspe(result_out_cut$GT, truth),
        MAE   = mae_fun(result_out_cut$GT, truth),
        MAPE  = safe_mape(result_out_cut$GT, truth),
        crps  = NA_real_,  
        mcr95  = NA_real_,
        mcr50  = NA_real_
      ),
      metric_tbl
    )
  }
  
  all_metrics[[state_i]] <- metric_tbl
}

# combine all states
final_metrics <- bind_rows(all_metrics)

# general table
out_dir <- file.path(path_proj, "outputs")
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
readr::write_csv(final_metrics, file.path(out_dir, "multi_state_metrics_with_crps_coverage.csv"))

cat(">>> Done. Combined metrics saved to: ",
    file.path(out_dir, "multi_state_metrics_with_crps_coverage.csv"), "\n")

```


---
title: "Time-varying parametric reported probability: OU process"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(cmdstanr)
library(splines)
library(ggplot2)
library(reshape2)
library(dplyr)
library(bayesplot)
```

```{r}
path_proj = here::here()
path_source_nowcasting <- file.path(dirname(path_proj), "nowcasting", "source")

source(file.path(path_source_nowcasting, "simulation", "simulations_functions_final.R"))
source(file.path(path_source_nowcasting, "functions", "prior_function.R"))
posterior_draws_path = file.path(path_source_nowcasting, "data", "draws", "testEach")


```

```{r}
b_ou <-  file.path(path_source_nowcasting, "models", "b-ou.stan")
model <- cmdstan_model(b_ou)

b_ou_lambda <- file.path(path_proj, "source", "models", "b-ou-GT-combined.stan")
# b_ou_lambda <- file.path(path_proj, "source", "models", "b-ou-GT-time-varying-betas.stan")
model_GT <- cmdstan_model(b_ou_lambda)
```
# GT
```{r}
# Helper function: scale a vector to [new_min, new_max]
scale_to_range <- function(x, new_min, new_max) {
  (x - min(x)) / (max(x) - min(x)) * (new_max - new_min) + new_min
}

# 1. Basic settings
set.seed(3)
years         <- 3
weeks_per_yr  <- 52
T_len         <- years * weeks_per_yr
t             <- seq_len(T_len)
week          <- ((t - 1) %% weeks_per_yr) + 1

# 2. Simulate seasonal effect s_true via cyclic second-order random walk
P             <- weeks_per_yr
sigma_s_true  <- 1.0    # innovation SD for the RW
s_true        <- numeric(P)
# initialize first two points
s_true[1]     <- rnorm(1, 0, sigma_s_true)
s_true[2]     <- rnorm(1, 0, sigma_s_true)
# cyclic second-order RW over weeks
for (p in 3:P) {
  s_true[p] <- rnorm(1,
                     mean = 2 * s_true[p-1] - s_true[p-2],
                     sd   = sigma_s_true)
}
# enforce cyclic boundary conditions
s_true[1] <- rnorm(1, 2 * s_true[P] - s_true[P-1], sigma_s_true)
s_true[2] <- rnorm(1, 2 * s_true[1] - s_true[P],     sigma_s_true)

# 3. Map seasonal effect onto a controlled interval for scaling
new_min_s <- -2    # choose as needed
new_max_s <-  2
s_true_scaled <- scale_to_range(s_true, new_min_s, new_max_s)

# 4. Assign seasonal effect to each time point
s_t <- s_true_scaled[week]

# 5. Simulate outbreak component (two Gaussian peaks)
outbreak_amp  <- 40
peak1         <- 15                  # first-year peak at week 15
peak3         <- peak1 + 2*weeks_per_yr
outbreak      <- outbreak_amp * (
  exp(-((t - peak1)^2)  / (2 * 2^2)) +
    exp(-((t - peak3)^2) / (2 * 2^2))
)

# 6. Build covariate X1 = outbreak + heteroscedastic noise
alpha_noise   <- 2
beta_noise    <- 0.05
noise_sd      <- alpha_noise + beta_noise * outbreak
cov_raw       <- outbreak + rnorm(T_len, 0, noise_sd)
X1            <- round(pmin(100, pmax(0, cov_raw)))  # truncate to [0,100]
ZT            <- (X1 - mean(X1)) / sd(X1)            # standardize for Stan

# 7. Simulate independent β_t ~ Normal(0, sigma_beta_true)
sigma_beta_true <- 0.005
beta_t_true     <- rnorm(T_len, 0, sigma_beta_true)

# 8. Simulate AR(1) residual η_t
rho_eta_true    <- 0.8
sigma_eta_true  <- 0.5
eta             <- numeric(T_len)
eta[1]          <- rnorm(1, 0, sigma_eta_true)
for (i in 2:T_len) {
  eta[i] <- rnorm(1, rho_eta_true * eta[i-1], sigma_eta_true)
}

# 9. Construct log-lambda and draw counts N_t
beta0_true    <- 2.5               # manually set intercept for scale
log_lambda    <- beta0_true + beta_t_true * ZT + eta + s_t
lambda        <- exp(log_lambda)
N             <- rpois(T_len, lambda)

# 10. Build Y matrix (no delays: only first column)
D             <- 5
Y             <- matrix(0L, nrow = T_len, ncol = D + 1)
Y[, 1]        <- N

# 11. Quick plots to verify
par(mfrow = c(4,1), mar = c(4,4,2,1))
plot(t, X1,          type = 'l', main = 'Covariate X1',     ylab = 'X1',         xlab = 'Time')
plot(t, s_t,         type = 'l', main = 'Seasonal s_t',     ylab = 's_t',        xlab = 'Time')
plot(t, beta_t_true, type = 'l', main = expression(beta[t]), ylab = expression(beta[t]), xlab = 'Time')
plot(t, lambda,      type = 'l', main = expression(lambda[t]), ylab = expression(lambda[t]), xlab = 'Time')
```

## Fully reported scenario

### Setting

```{r}
# data
# alpha_increase_seq_1 <- seq(10, 750, by = 30)
# alpha_decrease_seq_1 <- seq(750, 10, by = -30)
# alpha_lamb =  c( rep(10,5), alpha_increase_seq_1 + rnorm(alpha_increase_seq_1,10,10),
#                  alpha_decrease_seq_1 + rnorm(alpha_decrease_seq_1,10,10),
#                  rep(10,5))
alpha_lamb = lambda
beta_lamb = 0.5
T = 60
#D <- 15;
D <- 15
```

### Simulation

```{r}
params_b_ou_FR <- list(
  data = list(
    alpha_lamb = alpha_lamb,
    beta_lamb  = beta_lamb,
    T       = T,
    date_start = as.Date("2024-01-01"),
    D = D
  ),
  q_model = list(
    method        = "b_ou",
    method_params = list(theta_logb = 0.3, mu_logb = log(0.7), init_logb = log(0.7), sigma_logb = 0.5,
                         theta_logitphi = 0.3, mu_logitphi = 1, init_logitphi = 1, sigma_logitphi = 0.4)
  )
)
b_ou_FR <- simulateData(params_b_ou_FR)
par(mfrow = c(2, 1))
plot(b_ou_FR$b, pch = 19, type = "b")
plot(b_ou_FR$phi, pch = 19, type = "b")

par(mfrow = c(1, 1))
matplot(t(b_ou_FR$q), type = "l", lty = 1, ylim = c(0, 1))

cor(GT, b_ou_FR$case_true)

b_ou_FR$b
```


### Model fitting

```{r}
ind = 40
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
stan_data <- c(list(T = ind, D = D, Y = b_ou_FR$case_reported_cumulated[1:ind, ]), hypers)

test = model$sample(
    data = stan_data,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 0,
    thin = 1)
varnames <- test$summary()$variable

mcmc_areas(test$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_FR$b[1:ind]
)
mcmc_areas(test$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames, value = TRUE),
    x = 1 - b_ou_FR$phi[1:ind]
)
mcmc_areas(test$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_FR$lambda[1:ind]
)
mcmc_areas(test$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames, value = TRUE),
    x = b_ou_FR$q[10,]
)
mcmc_areas(test$draws(grep("^q\\[10,.+\\]$", varnames, value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_FR$case_true[1:ind, 1]
)
mcmc_areas(test$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```

```{r}
ind = 40
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
stan_data_GT <- c(list(T = ind, D = D, Y = b_ou_FR$case_reported_cumulated[1:ind, ]), hypers, 
               list(K = ncol(matrix(GT)), X = as.matrix(matrix(GT)[1:ind, 1])) )

test_GT = model_GT$sample(
    data = stan_data_GT,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 500,
    thin = 1)
varnames_GT <- test_GT$summary()$variable

mcmc_areas(test_GT$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test_GT$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test_GT$draws("beta_0"), prob = 0.95, prob_outer = 0.95)

param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$b[1:ind]
)
mcmc_areas(test_GT$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames_GT, value = TRUE),
    x = 1 - b_ou_FR$phi[1:ind]
)
mcmc_areas(test_GT$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$lambda[1:ind]
)
mcmc_areas(test_GT$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$q[10,]
)
mcmc_areas(test_GT$draws(grep("^q\\[10,.+\\]$", varnames_GT, value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$case_true[1:ind, 1]
)
mcmc_areas(test_GT$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^beta_t\\[.+\\]$", varnames_GT, value = TRUE),
    x = beta_t_scaled[1:ind]
)
mcmc_areas(test_GT$draws("beta_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

```

```{r}
vanilla <- test$summary(variables = "N")$mean
withGT <- test_GT$summary(variables = "N")$mean

error_metrics <- function(predicted, actual) {
  # same length
  stopifnot(length(predicted) == length(actual))
  
  # RMSE (Root Mean Squared Error)
  rmse <- sqrt(mean((predicted - actual)^2))
  
  # RMSPE (Root Mean Squared Percentage Error)
  rmspe <- sqrt(mean(((predicted - actual)/actual)^2)) * 100
  
  # MAE (Mean Absolute Error)
  mae <- mean(abs(predicted - actual))
  
  # MAPE (Mean Absolute Percentage Error)
  mape <- mean(abs((predicted - actual)/actual)) * 100

  list(RMSE = rmse,
       RMSPE = rmspe,
       MAE = mae,
       MAPE = mape)
}

print(error_metrics(vanilla[1:ind], b_ou_FR$case_true[1:ind]))

print(error_metrics(withGT[1:ind], b_ou_FR$case_true[1:ind]))

print(error_metrics(tail(vanilla[1:ind],5), tail(b_ou_FR$case_true[1:ind],5)))

print(error_metrics(tail(withGT[1:ind],5), tail(b_ou_FR$case_true[1:ind],5)))
```


## Non-fully reported scenario

### Simulation

```{r}
# ou_NFR
params_b_ou_NFR <- list(
  data = list(
    alpha_lamb = alpha_lamb,
    beta_lamb  = beta_lamb,
    T       = T,
    date_start = as.Date("2024-01-01"),
    D = D
  ),
  q_model = list(
    method        = "b_ou",
    method_params = list(theta_logb = 0.2, mu_logb = log(0.2), init_logb = log(0.2), sigma_logb = 0.4,
                         theta_logitphi = 0.2, mu_logitphi = 1.5, init_logitphi = 1.5, sigma_logitphi = 0.15)
  )
)

b_ou_NFR <- simulateData(params_b_ou_NFR)
par(mfrow = c(2, 1))
plot(b_ou_NFR$b, pch = 19, type = "b")
plot(b_ou_NFR$phi, pch = 19, type = "b")

par(mfrow = c(1, 1))
matplot(t(b_ou_NFR$q), type = "l", lty = 1, ylim = c(0, 1))

cor(GT, b_ou_NFR$case_true)
```

### Model fitting

```{r}
ind = 40
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
stan_data <- c(list(T = ind, D = D, Y = b_ou_NFR$case_reported_cumulated[1:ind, ]), hypers)

test = model$sample(
    data = stan_data,
    iter_sampling = 3000,
    iter_warmup = 3000,
    chains = 1,
    refresh = 0,
    thin = 1)
varnames <- test$summary()$variable

mcmc_areas(test$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test_GT$draws("beta_0"), prob = 0.95, prob_outer = 0.95)

param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_NFR$b[1:ind]
)
mcmc_areas(test$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_NFR$phi[1:ind]
)
mcmc_areas(test$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_NFR$lambda[1:ind]
)
mcmc_areas(test$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames, value = TRUE),
    x = b_ou_NFR$q[10,]
)
mcmc_areas(test$draws(grep("^q\\[10,.+\\]$", varnames, value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames, value = TRUE),
    x = b_ou_NFR$case_true[1:ind, 1]
)
mcmc_areas(test$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```

```{r}
ind = 40
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
stan_data_GT <- c(list(T = ind, D = D, Y = b_ou_NFR$case_reported_cumulated[1:ind, ]), hypers, 
               list(K = ncol(matrix(GT)), X = as.matrix(matrix(GT)[1:ind, 1])) )

test_GT = model_GT$sample(
    data = stan_data_GT,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 500,
    thin = 1)
varnames_GT <- test_GT$summary()$variable

mcmc_areas(test_GT$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test_GT$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$b[1:ind]
)
mcmc_areas(test_GT$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames_GT, value = TRUE),
    x = 1 - b_ou_FR$phi[1:ind]
)
mcmc_areas(test_GT$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$lambda[1:ind]
)
mcmc_areas(test_GT$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$q[10,]
)
mcmc_areas(test_GT$draws(grep("^q\\[10,.+\\]$", varnames_GT, value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames_GT, value = TRUE),
    x = b_ou_FR$case_true[1:ind, 1]
)
mcmc_areas(test_GT$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^beta_t\\[.+\\]$", varnames_GT, value = TRUE),
    x = beta_t_scaled[1:ind]
)
mcmc_areas(test_GT$draws("beta_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)


```

```{r}
vanilla <- test$summary(variables = "N")$mean
withGT <- test_GT$summary(variables = "N")$mean



print(error_metrics(vanilla[1:ind], b_ou_NFR$case_true[1:ind]))

print(error_metrics(withGT[1:ind], b_ou_NFR$case_true[1:ind]))

print(error_metrics(tail(vanilla[1:ind],5), tail(b_ou_NFR$case_true[1:ind],5)))

print(error_metrics(tail(withGT[1:ind],5), tail(b_ou_NFR$case_true[1:ind],5)))
```
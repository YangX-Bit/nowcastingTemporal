---
title: "Time-varying parametric reported probability: OU process"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(cmdstanr)
library(splines)
library(ggplot2)
library(reshape2)
library(dplyr)
library(bayesplot)
library(scoringRules)
```

```{r}
path_proj = here::here()
path_source_nowcasting <- file.path(dirname(path_proj), "nowcasting", "source")

source(file.path(path_source_nowcasting, "simulation", "simulations_functions_final.R"))
source(file.path(path_source_nowcasting, "functions", "prior_function.R"))
posterior_draws_path = file.path(path_source_nowcasting, "data", "draws", "testEach")

source(file.path(path_proj, "source", "functions", "simulation_functions.R"))
```

```{r}
b_ou <-  file.path(path_source_nowcasting, "models", "b-ou.stan")
model <- cmdstan_model(b_ou)

#file.path(dirname(dirname(path_proj)),"cmdstan-2.32.0")
#set_cmdstan_path(file.path(dirname(dirname(path_proj)),"cmdstan-2.32.0"))

b_ou_lambda <-  file.path(path_proj, "source", "models", "b-ou-GT-combined-seasonality-fourier.stan")
# b_ou_lambda <- file.path(path_proj, "source", "models", "b-ou-GT-time-varying-betas.stan")
model_GT <- cmdstan_model(b_ou_lambda)
```
# GT
```{r}
# -----------------------------------------------------------------------------
# smoother simulation with AR(1) disturbance & tunable x/s noise
# -----------------------------------------------------------------------------

set.seed(123)
years        <- 3
weeks_per_yr <- 52
T_len        <- years * weeks_per_yr
t            <- seq_len(T_len)
week         <- ((t - 1) %% weeks_per_yr) + 1

# exposure
E <- rep(10000, T_len)

# seasonal via Fourier
P     <- weeks_per_yr
H     <- 2
alpha <- rnorm(H, 0, 2)
gamma <- rnorm(H, 0, 2)
s_t_unstd <- numeric(T_len)
for (tt in 1:T_len) {
  angle <- 2 * pi * (week[tt] - 1) / P
  season <- 0
  for (h in 1:H) {
    season <- season +
      alpha[h] * cos(h * angle) +
      gamma[h] * sin(h * angle)
  }
  s_t_unstd[tt] <- season
}
s_t <- (s_t_unstd - mean(s_t_unstd)) / sd(s_t_unstd)

# covariate x_t
x_t <- rnorm(T_len)
x_t <- (x_t - mean(x_t)) / sd(x_t)

# AR(1) disturbance Îµ_t
rho_eps   <- 0.8
sigma_eps <- 0.5     
epsilon   <- numeric(T_len)
epsilon[1] <- rnorm(1, 0, sigma_eps)
for (tt in 2:T_len) {
  epsilon[tt] <- rho_eps * epsilon[tt-1] +
    rnorm(1, 0, sigma_eps * sqrt(1 - rho_eps^2))
}
var_eps_emp <- var(epsilon)

# scenarios
scenario_list <- list(
  list(name = "moderate noise", tau_x = 1, tau_s = 1),
  list(name = "season dominant", tau_x = 1, tau_s = 3)
)

beta0 <- -5  # logit intercept

results <- list()
for (sc in scenario_list) {
  tau_x <- sc$tau_x
  tau_s <- sc$tau_s
  # separate scales
  c_x <- sqrt(tau_x * var_eps_emp)
  c_s <- sqrt(tau_s * var_eps_emp)
  x_scaled <- c_x * x_t
  s_scaled <- c_s * s_t
  
  # build linear predictor / link
  log_lambda <- beta0 + x_scaled + s_scaled + epsilon
  lambda_t     <- exp(log_lambda)
  
  # simulate counts
  mu_t    <- E * lambda_t
  N_final <- rpois(T_len, mu_t)
  
  results[[sc$name]] <- list(
    x_scaled = x_scaled,
    s_scaled = s_scaled,
    epsilon  = epsilon,
    lambda_t = lambda_t,
    N_final  = N_final
  )
  
  par(mfrow = c(4, 1), mar = c(4, 4, 2, 1))
  plot(t, x_scaled, type = "l",
       main = paste("Scenario:", sc$name, "- x_scaled"),
       ylab = expression(x[t]), xlab = "Time")
  plot(t, s_scaled, type = "l",
       main = paste("Scenario:", sc$name, "- s_scaled"),
       ylab = expression(s[t]), xlab = "Time")
  plot(t, log_lambda, type = "l",
       main = paste("Scenario:", sc$name, "- log(lambda)"),
       ylab = expression(log(lambda[t])), xlab = "Time")
  plot(t, N_final, type = "h",
       main = paste("Scenario:", sc$name, "- N_final"),
       ylab = "Count", xlab = "Time")
}

lambda <- results[[1]]$N_final 
```

## Fully reported scenario

### Setting

```{r}
# data
# alpha_increase_seq_1 <- seq(10, 750, by = 30)
# alpha_decrease_seq_1 <- seq(750, 10, by = -30)
# alpha_lamb =  c( rep(10,5), alpha_increase_seq_1 + rnorm(alpha_increase_seq_1,10,10),
#                  alpha_decrease_seq_1 + rnorm(alpha_decrease_seq_1,10,10),
#                  rep(10,5))

# Time_len = 60
#D <- 15;
D <- 15
```

### Simulation

```{r}
params_b_ou_FR <- list(
  data = list(
    lambda = lambda,
    T       = T_len,
    date_start = as.Date("2024-01-01"),
    D = D
  ),
  q_model = list(
    method        = "b_ou",
    method_params = list(theta_logb = 0.3, mu_logb = log(0.7), init_logb = log(0.7), sigma_logb = 0.5,
                         theta_logitphi = 0.3, mu_logitphi = 1, init_logitphi = 1, sigma_logitphi = 0.4)
  )
)
b_ou_FR <- simulateData(params_b_ou_FR)
par(mfrow = c(2, 1))
plot(b_ou_FR$b, pch = 19, type = "b")
plot(b_ou_FR$phi, pch = 19, type = "b")

par(mfrow = c(1, 1))
matplot(t(b_ou_FR$q), type = "l", lty = 1, ylim = c(0, 1))

cor(results[[1]]$x_scaled, b_ou_FR$case_true)

b_ou_FR$lambda - lambda
#b_ou_FR$case_true = b_ou_FR$case_true+1
```

```{r}
vanila <- list()
withGT <- list()
```

### Model fitting

```{r}
#ind = seq(20, 156, by = 20)
ind = 52
varnames <- list()
vanilla <- list()
test <- list()
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
for (i in 1:length(ind)) {
  print(paste0("The ",i,"th simulation."))
  stan_data <- c(list(T = ind[i], D = D, Y = b_ou_FR$case_reported_cumulated[1:ind[i], ]), hypers)
  test[[i]] = model$sample(
    data = stan_data,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 0,
    thin = 1)
  varnames[[i]] <- test[[i]]$summary()$variable
  vanilla[[i]] <- test[[i]]$summary(variables = "N")$mean
}

```

```{r}
varnames_GT <- list()
withGT <- list()
test_GT <- list()
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
for (i in 1:length(ind)) {
  print(paste0("The ",i,"th simulation."))
  w = rep(1:P,3)[1:ind[i]]
  stan_data_GT <- c(list(T = ind[i], D = D, Y = b_ou_FR$case_reported_cumulated[1:ind[i], ]), hypers, 
               list(K = ncol(matrix(ZT)), X = as.matrix(matrix(ZT)[1:ind[i], 1]),
                    P = 52, w=w, E = rep(10000,156), H = 2))
test_GT[[i]] = model_GT$sample(
    data = stan_data_GT,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 500,
    thin = 1)
  varnames_GT[[i]] <- test_GT[[i]]$summary()$variable
  withGT[[i]] <- test_GT[[i]]$summary(variables = "N")$mean
}
```

```{r}
error_metrics <- function(predicted, actual) {
  # same length
  stopifnot(length(predicted) == length(actual))
  
  # RMSE (Root Mean Squared Error)
  rmse <- sqrt(mean((predicted - actual)^2))
  
  # RMSPE (Root Mean Squared Percentage Error)
  rmspe <- sqrt(mean(((predicted - actual)/actual)^2)) * 100
  
  # MAE (Mean Absolute Error)
  mae <- mean(abs(predicted - actual))
  
  # MAPE (Mean Absolute Percentage Error)
  mape <- mean(abs((predicted - actual)/actual)) * 100

  list(RMSE = rmse,
       RMSPE = rmspe,
       MAE = mae,
       MAPE = mape)
}

vanilla_combined <- list()
withGT_combined <- list()
for (i in 1:(length(ind)-1)) {
    print(paste0("The ",i,"th simulation."))
  print(error_metrics(vanilla[[i+1]], b_ou_FR$case_true[1:ind[i+1]]))
  print(error_metrics(withGT[[i+1]], b_ou_FR$case_true[1:ind[i+1]]))
  vanilla_combined[[i]] <- as.data.frame(error_metrics(vanilla[[i+1]], b_ou_FR$case_true[1:ind[i+1]]))
  withGT_combined[[i]] <- as.data.frame(error_metrics(withGT[[i+1]], b_ou_FR$case_true[1:ind[i+1]]))
}

mean_vanilla_combined <- Reduce(`+`, vanilla_combined) / length(vanilla_combined)
mean_withGT_combined <- Reduce(`+`, withGT_combined) / length(withGT_combined)

mean_vanilla_combined
mean_withGT_combined
```


```{r}
vanilla_combined_last <- list()
withGT_combined_last <- list()
last_len <- 5
for (i in 1:(length(ind)-1)) {
    print(paste0("The ",i,"th simulation."))
  print(error_metrics(tail(vanilla[[i+1]],last_len), tail(b_ou_FR$case_true[1:ind[i+1]],last_len)))
  print(error_metrics(tail(withGT[[i+1]],last_len), tail(b_ou_FR$case_true[1:ind[i+1]],last_len)))
  vanilla_combined_last[[i]] <- as.data.frame(error_metrics(tail(vanilla[[i+1]],last_len), tail(b_ou_FR$case_true[1:ind[i+1]],last_len)))
  withGT_combined_last[[i]] <- as.data.frame(error_metrics(tail(withGT[[i+1]],last_len), tail(b_ou_FR$case_true[1:ind[i+1]],last_len)))
}

mean_vanilla_combined_last <- Reduce(`+`, vanilla_combined_last) / length(vanilla_combined_last)
mean_withGT_combined_last <- Reduce(`+`, withGT_combined_last) / length(withGT_combined_last)

mean_vanilla_combined_last
mean_withGT_combined_last
```

```{r}
test_num <- 7

# GT
y_true <- b_ou_FR$case_true[1:ind[test_num]]

y_rep_mat <- test[[test_num]]$draws(variables = "N", format = "draws_matrix")
pred_mat <- t(y_rep_mat)

crps_vec  <- crps_sample(y   = y_true,  
                         dat = pred_mat)
mean_crps <- mean(crps_vec)

#
y_rep_mat_GT <- test_GT[[test_num]]$draws(variables = "N", format = "draws_matrix")
pred_mat_GT <- t(y_rep_mat_GT)

crps_vec_GT  <- crps_sample(y   = y_true,  
                         dat = pred_mat_GT)
mean_crps_GT <- mean(crps_vec_GT)

mean_crps
mean_crps_GT
```


```{r}
mcmc_areas(test[[7]]$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test[[7]]$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test[[7]]$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test[[7]]$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test[[7]]$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test[[7]]$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames[[7]], value = TRUE),
    x = b_ou_FR$b[1:ind[7]]
)
mcmc_areas(test[[7]]$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames[[7]], value = TRUE),
    x = 1 - b_ou_FR$phi[1:ind[7]]
)
mcmc_areas(test[[7]]$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames[[7]], value = TRUE),
    x = b_ou_FR$lambda[1:ind[7]]
)
mcmc_areas(test[[7]]$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames[[7]], value = TRUE),
    x = b_ou_FR$q[10,]
)
mcmc_areas(test[[7]]$draws(grep("^q\\[10,.+\\]$", varnames[[7]], value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames[[7]], value = TRUE),
    x = b_ou_FR$case_true[1:ind[7], 1]
)
mcmc_areas(test[[7]]$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```


```{r}
mcmc_areas(test_GT[[7]]$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT[[7]]$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT[[7]]$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT[[7]]$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test_GT[[7]]$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT[[7]]$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames_GT[[7]], value = TRUE),
    x = b_ou_FR$b[1:ind[7]]
)
mcmc_areas(test_GT[[7]]$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames_GT[[7]], value = TRUE),
    x = 1 - b_ou_FR$phi[1:ind[7]]
)
mcmc_areas(test_GT[[7]]$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames_GT[[7]], value = TRUE),
    x = b_ou_FR$lambda[1:ind[7]]
)
mcmc_areas(test_GT[[7]]$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames_GT[[7]], value = TRUE),
    x = b_ou_FR$q[10,]
)
mcmc_areas(test_GT[[7]]$draws(grep("^q\\[10,.+\\]$", varnames_GT[[7]], value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames_GT[[7]], value = TRUE),
    x = b_ou_FR$case_true[1:ind[7], 1]
)
mcmc_areas(test_GT[[7]]$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^beta_t\\[.+\\]$", varnames_GT[[7]], value = TRUE),
    x = beta_t_true[1:ind[7]]
)
mcmc_areas(test_GT[[7]]$draws("beta_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^s_t\\[.+\\]$", varnames_GT[[7]], value = TRUE),
    x = s_t[1:ind[7]]
)
mcmc_areas(test_GT[[7]]$draws("s_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```

## Non-fully reported scenario

### Simulation

```{r}
# ou_NFR
params_b_ou_NFR <- list(
  data = list(
    alpha_lamb = alpha_lamb,
    beta_lamb  = beta_lamb,
    T       = T_len,
    date_start = as.Date("2024-01-01"),
    D = D
  ),
  q_model = list(
    method        = "b_ou",
    method_params = list(theta_logb = 0.2, mu_logb = log(0.2), init_logb = log(0.2), sigma_logb = 0.4,
                         theta_logitphi = 0.2, mu_logitphi = 1.5, init_logitphi = 1.5, sigma_logitphi = 0.15)
  )
)

b_ou_NFR <- simulateData(params_b_ou_NFR)
par(mfrow = c(2, 1))
plot(b_ou_NFR$b, pch = 19, type = "b")
plot(b_ou_NFR$phi, pch = 19, type = "b")

par(mfrow = c(1, 1))
matplot(t(b_ou_NFR$q), type = "l", lty = 1, ylim = c(0, 1))

```



### Model fitting

```{r}
ind = seq(20, 156, by = 20)
varnames_NFR <- list()
vanilla_NFR <- list()
test_NFR <- list()
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
for (i in 1:length(ind)) {
  print(paste0("The ",i,"th simulation."))
  stan_data <- c(list(T = ind[i], D = D, Y = b_ou_NFR$case_reported_cumulated[1:ind[i], ]), hypers)
  test_NFR[[i]] = model$sample(
    data = stan_data,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 0,
    thin = 1)
  varnames_NFR[[i]] <- test_NFR[[i]]$summary()$variable
  vanilla_NFR[[i]] <- test_NFR[[i]]$summary(variables = "N")$mean
}

```

```{r}
varnames_GT_NFR <- list()
withGT_NFR <- list()
test_GT_NFR <- list()
hypers = hypers_q(phi_ref = 0.2, D_ref = 15, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
for (i in 1:length(ind)) {
  print(paste0("The ",i,"th simulation."))
  w = rep(1:P,3)[1:ind[i]]
  stan_data_GT_NFR <- c(list(T = ind[i], D = D, Y = b_ou_NFR$case_reported_cumulated[1:ind[i], ]), hypers, 
               list(K = ncol(matrix(ZT)), X = as.matrix(matrix(ZT)[1:ind[i], 1]),
                    P = 52, w=w))
test_GT_NFR[[i]] = model_GT$sample(
    data = stan_data_GT_NFR,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 500,
    thin = 1)
  varnames_GT_NFR[[i]] <- test_GT_NFR[[i]]$summary()$variable
  withGT_NFR[[i]] <- test_GT_NFR[[i]]$summary(variables = "N")$mean
}


```

```{r}
mcmc_areas(test_GT_NFR[[7]]$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT_NFR[[7]]$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT_NFR[[7]]$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT_NFR[[7]]$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test_GT_NFR[[7]]$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test_GT_NFR[[7]]$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = b_ou_NFR$b[1:ind[7]]
)
mcmc_areas(test_GT_NFR[[7]]$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = 1 - b_ou_NFR$phi[1:ind[7]]
)
mcmc_areas(test_GT_NFR[[7]]$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = b_ou_NFR$lambda[1:ind[7]]
)
mcmc_areas(test_GT_NFR[[7]]$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = b_ou_NFR$q[10,]
)
mcmc_areas(test_GT_NFR[[7]]$draws(grep("^q\\[10,.+\\]$", varnames_GT_NFR[[7]], value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = b_ou_NFR$case_true[1:ind[7], 1]
)
mcmc_areas(test_GT_NFR[[7]]$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^beta_t\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = beta_t_true[1:ind[7]]
)
mcmc_areas(test_GT_NFR[[7]]$draws("beta_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^beta_t\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = beta_t_true[1:ind[7]]
)
mcmc_areas(test_GT_NFR[[7]]$draws("beta_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^s_t\\[.+\\]$", varnames_GT_NFR[[7]], value = TRUE),
    x = s_t[1:ind[7]]
)
mcmc_areas(test_GT_NFR[[7]]$draws("s_t"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```


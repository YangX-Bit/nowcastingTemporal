---
title: "Time-varying parametric reported probability: OU process"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(cmdstanr)
library(splines)
library(ggplot2)
library(reshape2)
library(dplyr)
library(bayesplot)
library(scoringRules)
library(purrr)
```

```{r}
path_proj = here::here()
path_source_nowcasting <- file.path(dirname(path_proj), "nowcasting", "source")

source(file.path(path_source_nowcasting, "simulation", "simulations_functions_final.R"))
source(file.path(path_source_nowcasting, "functions", "prior_function.R"))
post_draws_path_NFRS = file.path(file.path(dirname(dirname(path_proj)),"projects","draws","NFRS"))

source(file.path(path_proj, "source", "functions", "simulation_functions.R"))

error_metrics <- function(predicted, actual) {
  ok <- is.finite(predicted) & is.finite(actual)
  predicted <- predicted[ok]
  actual    <- actual[ok]
  if (length(predicted) == 0L) {
    return(list(RMSE = NA_real_, RMSPE = NA_real_,
                MAE  = NA_real_, MAPE  = NA_real_))
  }
  # calc metrics
  rmse  <- sqrt(mean((predicted - actual)^2, na.rm = TRUE))
  rmspe <- sqrt(mean(((predicted - actual) / pmax(abs(actual), .Machine$double.eps))^2, na.rm = TRUE))
  mae   <- mean(abs(predicted - actual), na.rm = TRUE)
  mape  <- mean(abs((predicted - actual) / pmax(abs(actual), .Machine$double.eps)), na.rm = TRUE)
  list(RMSE = rmse, RMSPE = rmspe, MAE = mae, MAPE = mape)
}

set_cmdstan_path(file.path(dirname(dirname(path_proj)),"cmdstan-2.32.0"))
```

```{r}
b_ou <-  file.path(path_source_nowcasting, "models", "b-ou.stan")
model_bsl <- cmdstan_model(b_ou)

#file.path(dirname(dirname(path_proj)),"cmdstan-2.32.0")
#set_cmdstan_path(file.path(dirname(dirname(path_proj)),"cmdstan-2.32.0"))

b_ou_lambda <-  file.path(path_proj, "source", "models", "b-ou-GT-combined-seasonality-fourier-new.stan")
# b_ou_lambda <- file.path(path_proj, "source", "models", "b-ou-GT-time-varying-betas.stan")
model_prps <- cmdstan_model(b_ou_lambda)

#setting
iter_sampling = 2500
iter_warmup   = 1000
chains        = 4
refresh       = 0
thin          = 1
if_show_messages = F
```
# GT

```{r}
# --- preliminaries unchanged -------------------------------------------------
#set.seed(111)
# years <- 2; weeks_per_yr <- 52; T_len <- years * weeks_per_yr
# t     <- seq_len(T_len)
# week  <- ((t - 1) %% weeks_per_yr) + 1
# E     <- 1000
# 
# num_sims = 5
# n_weeks   <-  c(53,66,79,92,104)
# #n_weeks   <-  c(52)
# lambda_seq_NFRS <- matrix(NA, ncol = T_len, nrow = num_sims)
# 
# 
# # set the total var and ratio
# total_var = 0.033
# 
# tau_epsilon <- 1
# tau_ar <- 4
# tau_cov <- 4
# 
# sigma_epsilon <- sqrt(total_var * tau_epsilon / (tau_epsilon + tau_ar + tau_cov))
# sd_ar <- sqrt(total_var * tau_ar / (tau_epsilon + tau_ar + tau_cov))
# beta1 <- sqrt(total_var * tau_cov / (tau_epsilon + tau_ar + tau_cov))
# 
# # --- seasonality ---------------------------------------------------
# # --- baisc setting -------------------------------------------------
# H_max <- 10            # harmonic
# P     <- weeks_per_yr   # periodic
# 
# # --- Fourier basis -------------------------------------------------
# # to each h，we generate cos(h*angle) and sin(h*angle)
# angle <- 2 * pi * (t - 1) / P  # for each t we have one angle
# fourier_list <- lapply(1:H_max, function(h) {
#   cbind(
#     cos_h = cos(h * angle),
#     sin_h = sin(h * angle)
#   )
# })
# fourier_basis <- do.call(cbind, fourier_list)
# # column name
# colnames(fourier_basis) <- unlist(lapply(1:H_max, function(h) {
#   c(paste0("cos_h", h), paste0("sin_h", h))
# }))
# 
# # (fixed, to make it simplier)
# # --- coefficient beta_s for seasonality---------------------------------
# set.seed(3)
# H_used <- 5
# ratio  <- c(10, 2, 1, 1, 1) # ratio of each frequency (SD)）  
# sigma_s    <- 0.5                # total variance
# 
# # —— calc the scaling ratio c ——  
# # total "share" of var：
# sigma_s_raw <- sum(2 * (ratio^2))  
# # scaling ratio：
# c     <- sqrt(sigma_s / sigma_s_raw)  
# 
# # —— σ_h ——  
# sd_h   <- ratio * c           
# sd_all <- rep(sd_h, each = 2)  # twice，for each cos_h and sin_h  
# 
# # —— generate beta_s and s_t ——  
# beta_s <- rnorm(2 * H_used, mean = 0, sd = sd_all)  
# s_t    <- as.vector(fourier_basis[, 1:(2*H_used)] %*% beta_s)
# 
# # clear seeds
# rm(.Random.seed, envir = .GlobalEnv)
# 
# # sims loop
# 
# for (i in 1:num_sims) {
#   # --- (1) Independent noise ---------------------------------------------------
#   #sigma_epsilon  <- 0.1
#   epsilon_t    <- rnorm(T_len, mean = 0, sd = sigma_epsilon)
#   
#   # --- (2) Dependent noise ---------------------------------------------------
#   # sigma_epsilon = sqrt((1- rho_w^2) * var_ar)
#   #sd_ar <- 0.1
#   rho_w <- 0.8
#   sigma_w  <- sqrt((1-rho_w^2) * sd_ar^2)
#   w_t <- arima.sim(model = list(ar = rho_w), n = T_len,
#                    sd = sigma_w)
#   
#   # --- (3) covariate X_t -------------------------------------------------------
#   #x_t <- scale(rnorm(T_len))[, 1]        # standard normal, independent of other components
#   x_t <- rnorm(T_len) 
#   #beta1     <- 0.1
#   beta0 <- 0.2
#   
#   # --- (4) Risk -------------------------------------------------------
#   log_lambda <- beta0 + beta1 * x_t + s_t + w_t + epsilon_t
#   
#   lambda_t   <- exp(log_lambda)
#   mu_t  <- E * lambda_t
#   
#   lambda_seq_NFRS[i,] <- mu_t
# }

```

```{r}
# use the same data from FR for the outbreak scenario
lambda_seq_NFRS <- lambda_seq_FR
```

## Non-fully reported scenario

### Simulation - Not fully reported - Moderate

```{r}
D <- 15
data_NFRS <- list()

for (j in 1:num_sims) {
  data_NFRS[[j]] <- simulateData(
    params = list(
      data = list(
        lambda = lambda_seq_NFRS[j,],
        T       = T_len,
        date_start = as.Date("2024-01-01"),
        D = D
      ),
      q_model = list(
        method        = "b_ou",
        method_params = list(theta_logb = 0.7, mu_logb = log(0.05), init_logb = log(0.05), sigma_logb = 0.4,
                             theta_logitphi = 0.7, 
                             mu_logitphi = inverse_logistic_transform(0.05, 0, 1), 
                             init_logitphi = inverse_logistic_transform(0.05, 0, 1), sigma_logitphi = 0.15)
      )
    )
  )
}

par(mfrow = c(2, 3))
for (i in 1:num_sims) {
  matplot(t(data_NFRS[[i]]$q), type = "l", lty = 1, ylim = c(0, 1))
}


```

### Model fitting

```{r, warning=F}
t0_bsl_NFRS <- Sys.time()

# 1) param table
param_tbl_NFRS <- expand.grid(
  n_weeks = n_weeks,
  run     = seq_len(num_sims)
)

hypers = hypers_q(phi_ref = 0.1, D_ref = 25, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)
# 2) run everything

results_bsl_NFRS <- pmap(param_tbl_NFRS, function(n_weeks, run) {
  message("Simulating: ", n_weeks, " weeks — run ", run)
  
  stan_data <- c(
    list(
      T = n_weeks,
      D = D,
      Y = data_NFRS[[run]]$case_reported_cumulated[1:n_weeks, ]
    ),
    hypers
  )
suppressMessages(
  suppressWarnings(
      fit <- model_bsl$sample(
        data          = stan_data,
        iter_sampling = iter_sampling,
        iter_warmup   = iter_warmup,
        chains        = chains,
        parallel_chains = chains,
        refresh       = refresh,
        thin          = thin,
        show_messages = if_show_messages,
        output_dir = post_draws_path_NFRS
      )
    )
  )
  
  out <- list(
    files   = fit$output_files(),  # only save the path
    n_weeks = n_weeks,
    run     = run
  )
  rm(fit); gc()                    # release RAM
  out
})

# 4) Result (adress)
files_bsl_NFRS <- map(results_bsl_NFRS, "files")

t1_bsl_NFRS <- Sys.time()
```

```{r}
t0_prps_NFRS <- Sys.time()
hypers = hypers_q(phi_ref = 0.1, D_ref = 25, type = "exponential", alpha_phi = 1.4, sd_log_b = 1, delay_seq = 0:15)

# run everything
results_prps_NFRS <- pmap(param_tbl_NFRS, function(n_weeks, run) {
  message("Simulating: ", n_weeks, " weeks — run ", run)
  
  stan_data <-     c(
    list(T = n_weeks, 
         D = D, 
         Y = data_NFRS[[run]]$case_reported_cumulated[1:n_weeks, ]), 
    hypers, 
    list(K = ncol(matrix(x_t)), 
         x = as.matrix(matrix(x_t)[1:n_weeks, 1]),
         S = H_used*2,  
         bases_s = fourier_basis[(1:n_weeks),1:(H_used*2)],
         E = E
    )
  )
suppressMessages(
  suppressWarnings(
      fit <- model_prps$sample(
        data          = stan_data,
        iter_sampling = iter_sampling,
        iter_warmup   = iter_warmup,
        chains        = chains,
        parallel_chains = chains,
        refresh       = refresh,
        thin          = thin,
        show_messages = if_show_messages,
        output_dir = post_draws_path_NFRS
      )
    )
  )
  
  out <- list(
    files   = fit$output_files(),  # only save the path
    n_weeks = n_weeks,
    run     = run
  )
  rm(fit); gc()                    # release RAM
  out
})

# 4) Result
files_prps_NFRS <- map(results_prps_NFRS, "files")

t1_prps_NFRS <- Sys.time()
```



```{r}
n_w        <- length(n_weeks)
total_runs <- n_w * num_sims
last_lens  <- c(3, 4, 5, D)

# read the data, save the last D_th result
preds_bsl_D_NFRS  <- vector("list", total_runs)
preds_prps_D_NFRS <- vector("list", total_runs)
actual_D     <- vector("list", total_runs)

for (i in seq_along(n_weeks)) {
  wks <- n_weeks[i]
  for (run in seq_len(num_sims)) {
    idx <- (run - 1) * n_w + i
    
    # read last Dth
    preds_bsl_D_NFRS[[idx]]  <- get_N_lastL_mean(files_bsl_NFRS[[idx]],  wks, D)
    preds_prps_D_NFRS[[idx]] <- get_N_lastL_mean(files_prps_NFRS[[idx]], wks, D)
    
    # read last Dth
    actual_D[[idx]]     <- tail(data_NFRS[[run]]$case_true[1:wks], D)
  }
}

# --- 3) Calculate according to different L --------------------------------------
all_results_NFRS <- vector("list", length(last_lens))
names(all_results_NFRS) <- paste0("last_", last_lens)

for (li in seq_along(last_lens)) {
  L <- last_lens[li]
  
  # for each time t and simulations
  metrics_prps_NFRS <- replicate(n_w, vector("list", num_sims), simplify = FALSE)
  metrics_bsl_NFRS  <- replicate(n_w, vector("list", num_sims), simplify = FALSE)
  
  for (i in seq_along(n_weeks)) {
    for (run in seq_len(num_sims)) {
      idx <- (run - 1) * n_w + i
      
      # tail the saved data
      pred_bsl_L  <- tail(preds_bsl_D_NFRS[[idx]],  L)
      pred_prps_L <- tail(preds_prps_D_NFRS[[idx]], L)
      actual_L    <- tail(actual_D[[idx]],     L)
      
      metrics_bsl_NFRS[[i]][[run]]  <- error_metrics(pred_bsl_L,  actual_L)
      metrics_prps_NFRS[[i]][[run]] <- error_metrics(pred_prps_L, actual_L)
    }
  }
  
  # combine
  out <- data.frame(
    last_len = L,
    n_weeks  = n_weeks,
    prps_RMSE  = NA_real_, prps_RMSPE = NA_real_, prps_MAE = NA_real_, prps_MAPE = NA_real_,
    bsl_RMSE   = NA_real_, bsl_RMSPE  = NA_real_, bsl_MAE  = NA_real_, bsl_MAPE  = NA_real_
  )
  
  for (i in seq_along(n_weeks)) {
    prps_list <- metrics_prps_NFRS[[i]]
    bsl_list  <- metrics_bsl_NFRS[[i]]
    
    # metrics
    get_vec <- function(lst, nm) vapply(lst, function(x) x[[nm]], numeric(1L))
    out$prps_RMSE[i]  <- mean(get_vec(prps_list, "RMSE"),  na.rm = TRUE)
    out$prps_RMSPE[i] <- mean(get_vec(prps_list, "RMSPE"), na.rm = TRUE)
    out$prps_MAE[i]   <- mean(get_vec(prps_list, "MAE"),   na.rm = TRUE)
    out$prps_MAPE[i]  <- mean(get_vec(prps_list, "MAPE"),  na.rm = TRUE)
    
    out$bsl_RMSE[i]   <- mean(get_vec(bsl_list, "RMSE"),   na.rm = TRUE)
    out$bsl_RMSPE[i]  <- mean(get_vec(bsl_list, "RMSPE"),  na.rm = TRUE)
    out$bsl_MAE[i]    <- mean(get_vec(bsl_list, "MAE"),    na.rm = TRUE)
    out$bsl_MAPE[i]   <- mean(get_vec(bsl_list, "MAPE"),   na.rm = TRUE)
  }
  
  all_results_NFRS[[li]] <- out
}

final_tbl_NFRS <- do.call(rbind, all_results_NFRS)
row.names(final_tbl_NFRS) <- NULL

final_long_NFRS <- final_tbl_NFRS %>%
  tidyr::pivot_longer(
    cols      = -c(last_len, n_weeks),
    names_to  = c("model", "metric"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  tidyr::pivot_wider(
    names_from  = model,
    values_from = value
  ) %>%
  dplyr::mutate(across(c(prps, bsl), ~ round(.x, 2)),
                diff_bsl_minus_prps = bsl - prps)

final_long_NFRS

## check NAs
# check the NAs out of all sims
bsl_has_na_NFRS  <- vapply(preds_bsl_D_NFRS,  anyNA, logical(1))
prps_has_na_NFRS <- vapply(preds_prps_D_NFRS, anyNA, logical(1))  

data.frame(
  model    = c("bsl", "prps"),
  total    = c(length(preds_bsl_D_NFRS), length(preds_prps_D_NFRS)),
  with_NA  = c(sum(bsl_has_na_NFRS), sum(prps_has_na_NFRS)),
  na_prop  = c(mean(bsl_has_na_NFRS), mean(prps_has_na_NFRS))
)

```





```{r}
all_crps_NFRS <- vector("list", length(last_lens))
names(all_crps_NFRS) <- paste0("last_", last_lens)

all_cr50_NFRS <- vector("list", length(last_lens))
all_cr95_NFRS <- vector("list", length(last_lens))
names(all_cr95_NFRS) <- names(all_cr50_NFRS) <- names(all_crps_NFRS)

for (li in seq_along(last_lens)) {
  L <- last_lens[li]
  
  crps_prps <- numeric(length(n_weeks))
  crps_bsl  <- numeric(length(n_weeks))
  cr50_prps <- numeric(length(n_weeks))
  cr50_bsl  <- numeric(length(n_weeks))
  cr95_prps <- numeric(length(n_weeks))
  cr95_bsl  <- numeric(length(n_weeks))
  
  for (i in seq_along(n_weeks)) {
    wks <- n_weeks[i]
    tmp_prps <- numeric(num_sims)
    tmp_bsl  <- numeric(num_sims)
    tmp_cr50_prps <- numeric(num_sims)
    tmp_cr50_bsl  <- numeric(num_sims)
    tmp_cr95_prps <- numeric(num_sims)
    tmp_cr95_bsl  <- numeric(num_sims)
    
    for (run in seq_len(num_sims)) {
      idx    <- (run - 1) * length(n_weeks) + i
      y_true <- tail(data_NFRS[[run]]$case_true[1:wks], L)
      
      pred_prps <- get_N_lastL_draws(files_prps_NFRS[[idx]], wks, L)
      pred_bsl  <- get_N_lastL_draws(files_bsl_NFRS[[idx]],  wks, L)
      
      # CRPS
      tmp_prps[run] <- mean(crps_sample(y = y_true, dat = pred_prps))
      tmp_bsl[run]  <- mean(crps_sample(y = y_true, dat = pred_bsl))
      
      # 50%
      tmp_cr50_prps[run] <- coverage_rate_sample(y_true, pred_prps, level = 0.50)
      tmp_cr50_bsl[run]  <- coverage_rate_sample(y_true, pred_bsl,  level = 0.50)
      # 95%
      tmp_cr95_prps[run] <- coverage_rate_sample(y_true, pred_prps, level = 0.95)
      tmp_cr95_bsl[run]  <- coverage_rate_sample(y_true, pred_bsl,  level = 0.95)
      
      rm(pred_prps, pred_bsl); gc()
    }
    
    crps_prps[i] <- mean(tmp_prps)
    crps_bsl[i]  <- mean(tmp_bsl)
    cr50_prps[i] <- mean(tmp_cr50_prps)
    cr50_bsl[i]  <- mean(tmp_cr50_bsl)
    cr95_prps[i] <- mean(tmp_cr95_prps)
    cr95_bsl[i]  <- mean(tmp_cr95_bsl)
  }
  
  # --- assemble data.frames ---
  all_crps_NFRS[[li]] <- data.frame(
    last_len  = L,
    n_weeks   = n_weeks,
    metric    = "CRPS",
    prps      = crps_prps,
    bsl       = crps_bsl,
    diff_bsl_minus_prps = crps_bsl - crps_prps
  )
  
  all_cr50_NFRS[[li]] <- data.frame(
    last_len  = L,
    n_weeks   = n_weeks,
    metric    = "CR50",               
    prps      = cr50_prps,            
    bsl       = cr50_bsl,
    diff_bsl_minus_prps = cr50_bsl - cr50_prps
  )
  
  #  95% coverage
  all_cr95_NFRS[[li]] <- data.frame(
    last_len  = L,
    n_weeks   = n_weeks,
    metric    = "CR95",               
    prps      = cr95_prps,
    bsl       = cr95_bsl,
    diff_bsl_minus_prps = cr95_bsl - cr95_prps
  )
}

final_crps_tbl_NFRS  <- do.call(rbind, all_crps_NFRS)
final_cr50_tbl_NFRS <- do.call(rbind, all_cr50_NFRS)
final_cr95_tbl_NFRS <- do.call(rbind, all_cr95_NFRS)

# Optionally combine:
final_NFRS <- rbind(final_crps_tbl_NFRS, final_cr50_tbl_NFRS, final_cr95_tbl_NFRS)
rownames(final_NFRS) <- NULL
print(final_NFRS)

```

```{r}
library(matrixStats)
maxL <- max(last_lens)

# make the list for simulations
idx_df <- tidyr::expand_grid(run = seq_len(num_sims), i = seq_along(n_weeks)) %>%
  mutate(wks = n_weeks[i], idx = (run - 1) * length(n_weeks) + i)

# to store the sample 
cache_prps <- vector("list", nrow(idx_df))
cache_bsl  <- vector("list", nrow(idx_df))

for (r in seq_len(nrow(idx_df))) {
  wks <- idx_df$wks[r]; id <- idx_df$idx[r]
  cache_prps[[r]] <- get_last_maxL_draws(files_prps_NFRS[[id]], wks, maxL)
  cache_bsl[[r]]  <- get_last_maxL_draws(files_bsl_NFRS[[id]],  wks, maxL)
}

# store the results
all_crps <- vector("list", length(last_lens))
all_cr50 <- vector("list", length(last_lens))
all_cr95 <- vector("list", length(last_lens))
names(all_crps) <- names(all_cr50) <- names(all_cr95) <- paste0("last_", last_lens)

for (li in seq_along(last_lens)) {
  L <- last_lens[li]
  crps_prps <- numeric(length(n_weeks))
  crps_bsl  <- numeric(length(n_weeks))
  cr50_prps <- numeric(length(n_weeks))
  cr50_bsl  <- numeric(length(n_weeks))
  cr95_prps <- numeric(length(n_weeks))
  cr95_bsl  <- numeric(length(n_weeks))
  
  for (i in seq_along(n_weeks)) {
    wks <- n_weeks[i]
    # initialize
    tmp_prps      <- rep(NA_real_, num_sims)
    tmp_bsl       <- rep(NA_real_, num_sims)
    tmp_cr50_prps <- rep(NA_real_, num_sims)
    tmp_cr50_bsl  <- rep(NA_real_, num_sims)
    tmp_cr95_prps <- rep(NA_real_, num_sims)
    tmp_cr95_bsl  <- rep(NA_real_, num_sims)
    
    for (run in seq_len(num_sims)) {
      r <- (run - 1) * length(n_weeks) + i          # 
      Mpr <- cache_prps[[r]]
      Mbs <- cache_bsl[[r]]
      if (is.null(Mpr) || is.null(Mbs)) next        # drop NAs
      
      # take last N rows
      MprL <- tail(Mpr, L)
      MbsL <- tail(Mbs, L)
      
      y_true <- tail(data_NFRS[[run]]$case_true[1:wks], L)
      
      # CRPS：take the average 
      tmp_prps[run] <- mean(scoringRules::crps_sample(y = y_true, dat = MprL))
      tmp_bsl[run]  <- mean(scoringRules::crps_sample(y = y_true, dat = MbsL))
      
      # CR
      tmp_cr50_prps[run] <- coverage_rate_sample_fast(y_true, MprL, level = 0.50)
      tmp_cr50_bsl[run]  <- coverage_rate_sample_fast(y_true, MbsL, level = 0.50)
      tmp_cr95_prps[run] <- coverage_rate_sample_fast(y_true, MprL, level = 0.95)
      tmp_cr95_bsl[run]  <- coverage_rate_sample_fast(y_true, MbsL, level = 0.95)
    }
    
    # mean of each run
    crps_prps[i] <- mean(tmp_prps, na.rm = TRUE)
    crps_bsl[i]  <- mean(tmp_bsl,  na.rm = TRUE)
    cr50_prps[i] <- mean(tmp_cr50_prps, na.rm = TRUE)
    cr50_bsl[i]  <- mean(tmp_cr50_bsl,  na.rm = TRUE)
    cr95_prps[i] <- mean(tmp_cr95_prps, na.rm = TRUE)
    cr95_bsl[i]  <- mean(tmp_cr95_bsl,  na.rm = TRUE)
  }
  
  # table result
  all_crps[[li]] <- data.frame(
    last_len = L, n_weeks = n_weeks, metric = "CRPS",
    prps = crps_prps, bsl = crps_bsl,
    diff_bsl_minus_prps = crps_bsl - crps_prps
  )
  all_cr50[[li]] <- data.frame(
    last_len = L, n_weeks = n_weeks, metric = "CR50",
    prps = cr50_prps, bsl = cr50_bsl,
    diff_bsl_minus_prps = cr50_bsl - cr50_prps
  )
  all_cr95[[li]] <- data.frame(
    last_len = L, n_weeks = n_weeks, metric = "CR95",
    prps = cr95_prps, bsl = cr95_bsl,
    diff_bsl_minus_prps = cr95_bsl - cr95_prps
  )
}

final_crps_tbl_NFRS <- do.call(rbind, all_crps)
final_cr50_tbl_NFRS <- do.call(rbind, all_cr50)
final_cr95_tbl_NFRS <- do.call(rbind, all_cr95)
final_NFRS <- rbind(final_crps_tbl_NFRS, final_cr50_tbl_NFRS, final_cr95_tbl_NFRS)
rownames(final_NFRS) <- NULL
print(final_NFRS)
```


# generate table for plots
```{r}
library(tibble)

# Pick one replicate and CI levels
m <- 5
ci_levels <- c(0.5, 0.95)

# NFRS
preds_result_NFRS <- make_run_summary_cumulative(
  scenario_name = "NFRS",
  run      = m,
  n_weeks  = n_weeks,
  base_L   = D,
  levels   = ci_levels,
  data_list = data_NFRS,
  files_bsl = files_bsl_NFRS,
  files_prps= files_prps_NFRS
)
```

```{r}
path_to_save_NFRS <- file.path(path_proj, "data", "simulation","results","NFRS")

# sim data
saveRDS(data_NFRS, file = file.path(path_to_save_NFRS, "data_NFRS.rds"))
# path
saveRDS(files_prps_NFRS, file = file.path(path_to_save_NFRS, "files_prps_NFRS.rds"))
saveRDS(files_bsl_NFRS,  file = file.path(path_to_save_NFRS, "files_bsl_NFRS.rds"))
# metrics
saveRDS(final_long_NFRS, file = file.path(path_to_save_NFRS, "final_long_NFRS.rds"))
saveRDS(final_NFRS, file = file.path(path_to_save_NFRS, "final_NFRS.rds"))
# prediction results
saveRDS(preds_result_NFRS, file = file.path(path_to_save_NFRS, "final_NFRS_predictions.rds"))
```


```{r}
files_prps_NFRS <- readRDS(file.path(path_to_save_NFRS, "files_prps_NFRS.rds"))
files_bsl_NFRS  <- readRDS(file.path(path_to_save_NFRS, "files_bsl_NFRS.rds"))

# result table
final_long_NFRS     <- readRDS(file.path(path_to_save_NFRS, "final_long_NFRS.rds"))
final_NFRS <- readRDS(file.path(path_to_save_NFRS, "final_NFRS.rds"))

preds_result_NFRS <- readRDS(file.path(path_to_save_NFRS, "final_NFRS_predictions.rds"))
```


---
title: "Untitled"
output: html_document
date: "2025-08-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(cmdstanr)
library(splines)
library(ggplot2)
library(reshape2)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
```


```{r results table}
# add label
final_long_FR   <- final_long_FR   %>% mutate(scenario = "FR")
final_long_NFRM <- final_long_NFRM %>% mutate(scenario = "NFRM")
final_long_NFRS <- final_long_NFRS %>% mutate(scenario = "NFRS")

final_FR <- final_FR %>% mutate(scenario = "FR")
final_NFRM <- final_NFRM %>% mutate(scenario = "NFRM")
final_NFRS <- final_NFRS %>% mutate(scenario = "NFRS")

# combine
final_long_all <- bind_rows(final_long_FR, final_long_NFRM, final_long_NFRS, 
                            final_FR, final_NFRM, final_NFRS)

# reslult
head(final_long_all)

```




```{r}
metrics <- c("RMSE","RMSPE","CR95","CR50","CRPS")
last_lens <- c(4,15)
scenarios <- c("FR", "NFRM", "NFRS")

for (i in 1:length(last_lens)) {
  for (j in 1:length(scenarios)) {
    df_long <- filter_metric_pairs(final_long_all, last_len = last_lens[i], scenario = scenarios[j],
                               metrics = metrics, baseline_col = "bsl", proposed_col = "prps")
    ww <- to_wide_metric_pairs(df_long, metrics = metrics, digits = 2)
    
    df_hi <- highlight_metric_pairs_simple(
      df_wide    = ww$wide_print,
      metrics    = metrics,
      directions = c(RMSE="lower", RMSPE="lower", CR95="closer", CR50="closer", CRPS="lower"),
      targets    = c(CR95=0.95, CR50=0.50),  # or 95/50 if your data are percentages
      color = "red",
      tie_highlight = FALSE                   # <- no highlight on ties
)

    latex_tab <- render_latex_metric_pairs(
      df_print = df_hi,
      caption  = paste0("Baseline vs Proposed across metrics (", scenario = scenarios[j], "; last ", last_lens[i]  ," weeks)")
)
    cat(latex_tab)
    cat("\n") 
  }
}


```

```{r}
metrics <- c("RMSE","RMSPE","CRPS","CR95","CR50")

latex_tab <- build_multi_scenario_table_latex(
  data        = final_long_all,
  last_len    = 4,
  scenarios   = c("FR","NFRM","NFRS"),
  metrics     = metrics,
  directions  = c(RMSE="lower", RMSPE="lower", CR95="closer", CR50="closer", CRPS="lower"),
  targets     = c(CR95=0.95, CR50=0.50),   
  digits      = 2,
  color       = "red",
  caption     = "Baseline vs Proposed across metrics (FR / NFRM / NFRS; last 4 weeks)"
)

cat(latex_tab)

```

# preds table for plot 
```{r}
library(tibble)

# Pick one replicate and CI levels
m <- 1
ci_levels <- c(0.5, 0.95)

# FR
preds_result_FR <- make_run_summary_cumulative(
  scenario_name = "FR",
  run      = m,
  n_weeks  = n_weeks,
  base_L   = D,
  levels   = ci_levels,
  data_list = data_FR,
  files_bsl = files_bsl_FR,
  files_prps= files_prps_FR
)

# NFRM
preds_result_NFRM <- make_run_summary_cumulative(
  scenario_name = "NFRM",
  run      = m,
  n_weeks  = n_weeks,
  base_L   = D,
  levels   = ci_levels,
  data_list = data_NFRM,
  files_bsl = files_bsl_NFRM,
  files_prps= files_prps_NFRM
)


# NFRS
preds_result_NFRS <- make_run_summary_cumulative(
  scenario_name = "NFRS",
  run      = m,
  n_weeks  = n_weeks,
  base_L   = D,
  levels   = ci_levels,
  data_list = data_NFRS,
  files_bsl = files_bsl_NFRS,
  files_prps= files_prps_NFRS
)

preds_result <- bind_rows(preds_result_FR, preds_result_NFRM, preds_result_NFRS)
```


```{r}
library(dplyr)
library(ggplot2)

# ---- choose replicate & CI level ----
run_to_plot <- m
ci_level    <- 0.95
tag         <- as.integer(round(ci_level * 100))
lcol        <- paste0("l", tag)
ucol        <- paste0("u", tag)

# ---- filter & order ----
df_plot <- preds_result %>%
  filter(run == run_to_plot, scenario %in% c("FR","NFRM","NFRS")) %>%
  mutate(
    scenario = factor(scenario, levels = c("FR","NFRM","NFRS")),
    model    = factor(model, levels = c("Baseline","Proposed"))
  )

# enforce left-to-right time order in facets (e.g., 53,66,79,92,104)
levels_eval <- paste0("t = ", sort(unique(df_plot$eval_t)))
df_plot <- df_plot %>%
  mutate(eval_lab = factor(paste0("t = ", eval_t), levels = levels_eval))

# print(table(df_plot$scenario, df_plot$model, useNA = "ifany"))

# ---- colors ----
method_colors <- c(
  "Baseline"       = "#96C37D",
  "Proposed"       = "#2F7FC1",
  "Actual cases"   = "#C82423",
  "Reported cases" = "black"
)

sims_result_plot <- ggplot(df_plot, aes(x = week)) +
  # ribbons
  geom_ribbon(
    aes(ymin = .data[[lcol]], ymax = .data[[ucol]],
        fill = model,
        group = interaction(scenario, model, eval_lab)),
    alpha = 0.25, show.legend = FALSE, na.rm = TRUE
  ) +
  # posterior means
  geom_line(
    aes(y = mean, color = model,
        group = interaction(scenario, model, eval_lab)),
    linewidth = 0.4, show.legend = FALSE, na.rm = TRUE
  ) +
  # reported overlay 
  geom_line(
    aes(y = reported, color = "Reported cases",
        group = interaction(scenario, model, eval_lab)),
    linewidth = 0.4, show.legend = TRUE, na.rm = TRUE
  ) +
  geom_point(
    aes(y = reported, color = "Reported cases",
        group = interaction(scenario, model, eval_lab)),
    size = 0.5, show.legend = TRUE, na.rm = TRUE
  ) +
  # truth overlay
  geom_line(
    aes(y = truth, color = "Actual cases",
        group = interaction(scenario, model, eval_lab)),
    linewidth = 0.5, linetype = 6, show.legend = TRUE, na.rm = TRUE
  ) +
  facet_grid(
    rows = vars(scenario, model), 
    cols = vars(eval_lab),         
    scales = "free_x",
    switch = "y"
  ) +
  scale_color_manual(
    values = method_colors,
    breaks = c("Actual cases","Reported cases"),
    name = NULL
  ) +
  scale_fill_manual(
    values = method_colors[c("Baseline","Proposed")],
    guide = "none"
  ) +
  labs(x = NULL, y = "Number of cases") +
  theme_bw(base_size = 10) +
  theme(
    legend.position      = c(0.15, 0.995),        
    legend.justification = c(1, 1),
    legend.background    = element_rect(fill = scales::alpha("white", 0.75), color = NA),
    legend.key.height    = unit(0.25, "cm"),
    legend.key.width     = unit(0.5, "cm"),    
    legend.text          = element_text(size = 7), 
    strip.background     = element_blank(),
    strip.text           = element_text(face = "bold"),
    panel.grid.minor     = element_blank(),
    panel.grid.major.x   = element_blank(),
    axis.title.y         = element_text(margin = margin(r = 6))
  ) +
  guides(color = guide_legend(
    override.aes = list(
      linetype  = c(6, 1),      
      shape     = c(NA, 16),    
      linewidth = c(0.5, 0.5),
      size      = c(NA, 1)      # point size
    )
  ))

print(sims_result_plot)

ggsave(filename = file.path(path_proj, "plots_to_show", "simulation", "sims-results.png"),
       plot = sims_result_plot,
       width = 8, height = 6, dpi = 300)

```

